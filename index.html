<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="description" content="Practice real conversations with IZZY, the AI avatar coach.">
  <meta property="og:image" content="/img/og.png">
  <meta property="og:title" content="IZZY – AI Avatar for Real Conversations">
  <meta property="og:description" content="Practice real conversations with IZZY, the AI avatar coach.">
  <meta property="og:url" content="https://your‑domain.com">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://your‑domain.com/img/og.png">
  <meta property="og:image:alt" content="Screenshot of IZZY AI avatar app">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IZZY – AI Avatar for Real Conversations</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* Basic Reset & Font */
    * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background: #fff; color:#333; }

    /* Backdrop-blur card effect */
    .glass {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 20px 25px rgba(0,0,0,0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Blur background behind modals */
    .blur-background { filter: blur(8px); pointer-events:none; }

    /* Simple fade-in animation */
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:none;} }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }

    /* Hidden helper class */
    .visually-hidden { display:none; }

    /* Chat bubble styling */
    .chat-bubble {
      border-radius: 18px;
      padding: 10px 15px;
      max-width: 80%;
      margin-bottom: 10px;
      word-wrap: break-word;
    }
    .user-bubble {
      background-color: #E9F3FF;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .assistant-bubble {
      background-color: #F2F2F7;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    /* Focus states for better accessibility */
    button:focus, input:focus, a:focus, iframe:focus, textarea:focus {
      outline: 2px solid #8B5CF6;
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
    }
    iframe:focus {
      border: none;
    }

    /* Loading spinner animation */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 3px solid #8B5CF6;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile menu styles */
    .mobile-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 100;
      padding: 2rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .mobile-menu.open {
      transform: translateX(0);
    }

    .mobile-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .mobile-menu-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    /* Mobile responsiveness */
    @media (max-width: 640px) {
      .desktop-nav {
        display: none;
      }
      .mobile-nav-button {
        display: block;
      }
    }

    @media (min-width: 641px) {
      .mobile-nav-button {
        display: none;
      }
      .mobile-menu {
        display: none;
      }
      .desktop-nav {
        display: flex;
      }
    }

    /* Subscription styles */
    .plan-card {
      transition: all 0.3s ease;
    }
    .plan-card:hover {
      transform: translateY(-8px);
    }
    .popular-badge {
      position: absolute;
      top: -12px;
      right: 20px;
      background: linear-gradient(to right, #9333ea, #ec4899);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .gradient-border {
      position: relative;
      border-radius: 1rem;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(to right, #9333ea, #ec4899) border-box;
      border: 2px solid transparent;
    }

    /* Share styles */
    .share-button {
      transition: all .3s ease;
    }
    .share-button:hover {
      transform: translateY(-3px);
    }
    .gradient-card {
      background: linear-gradient(white,white) padding-box,
                  linear-gradient(to right,#9333ea,#ec4899) border-box;
      border: 2px solid transparent;
      border-radius: 1rem;
    }
    .gradient-bg {
      background: linear-gradient(135deg,rgba(147,51,234,.08),rgba(236,72,153,.08));
    }
    .disabled {
      opacity: .5;
      cursor: not-allowed !important;
      transform: none !important;
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'izzy-blue': '#0047AB',
            'izzy-purple': {
              500: '#8B5CF6',
              600: '#7C3AED',
              700: '#6D28D9'
            },
            'izzy-pink': {
              500: '#EC4899',
              600: '#DB2777'
            }
          },
        }
      },
    }
  </script>
</head>

<body class="bg-gray-50">

<div class="mobile-header">
    <button class="mobile-menu-button" onclick="toggleMobileMenu()">☰</button>
    <h1>IZZY</h1>
    <div style="width: 40px;"></div>
</div>

<div class="mobile-menu hidden">
    <div class="mobile-menu-header">
        <h2>Menu</h2>
        <button class="mobile-menu-close" onclick="toggleMobileMenu()">×</button>
    </div>
    <div class="mobile-menu-content">
        <a href="#" class="mobile-menu-item" onclick="showSubscriptionModal()">Upgrade to Premium</a>
        <a href="#" class="mobile-menu-item" onclick="showReferralModal()">Invite Friends</a>
        <a href="#" class="mobile-menu-item" onclick="clearConversation()">Clear Chat</a>
        <a href="#" class="mobile-menu-item" onclick="showSettings()">Settings</a>
    </div>
</div>

<div class="mobile-menu-overlay"></div>

<!-- Main Chat Interface -->
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- User Progress Bar -->
    <div class="user-progress glass mb-6">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center">
                <span class="text-sm font-medium text-gray-600">Free Prompts Left:</span>
                <span id="prompts-left" class="ml-2 text-lg font-bold text-izzy-purple-600">3</span>
            </div>
            <div class="flex items-center">
                <span class="text-sm font-medium text-gray-600">Conversations:</span>
                <span id="conversation-count" class="ml-2 text-lg font-bold text-izzy-purple-600">0</span>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="prompts-progress-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 100%"></div>
        </div>
        <div id="prompts-warning" class="hidden mt-2 text-sm text-red-600">
            You have <span id="prompts-warning-count">1</span> prompt left!
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container glass h-[calc(100vh-12rem)] overflow-y-auto mb-4 p-4">
        <div id="chat-messages" class="space-y-4">
            <!-- Messages will be added here -->
        </div>
    </div>

    <!-- Message Input -->
    <div class="message-input-container glass p-4">
        <div class="flex items-center space-x-4">
            <textarea 
                id="user-input" 
                class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-izzy-purple-500 focus:border-transparent resize-none"
                placeholder="Type your message..."
                rows="1"
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
            ></textarea>
            <button 
                id="send-button"
                onclick="sendMessage()"
                class="bg-izzy-purple-500 text-white px-6 py-3 rounded-lg hover:bg-izzy-purple-600 transition-colors flex items-center"
            >
                <span id="send-button-text">Send</span>
                <div id="send-button-spinner" class="spinner hidden"></div>
            </button>
        </div>
    </div>
</div>

<!-- Subscription Modal -->
<div id="subscription-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="container mx-auto px-4 h-full flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full relative">
            <button onclick="closeSubscribeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h2 class="text-2xl font-bold mb-6 text-center">Upgrade to Premium</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="plan-card glass p-6 relative">
                    <h3 class="text-xl font-bold mb-4">Monthly</h3>
                    <div class="text-3xl font-bold mb-4">$9.99<span class="text-lg text-gray-600">/mo</span></div>
                    <ul class="space-y-2 mb-6">
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            Unlimited prompts
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            Priority support
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            Advanced features
                        </li>
                    </ul>
                    <button onclick="subscribe('monthly')" class="w-full bg-izzy-purple-500 text-white py-3 rounded-lg hover:bg-izzy-purple-600 transition-colors">
                        Subscribe Monthly
                    </button>
                </div>
                <div class="plan-card glass p-6 relative gradient-border">
                    <div class="popular-badge">Most Popular</div>
                    <h3 class="text-xl font-bold mb-4">Yearly</h3>
                    <div class="text-3xl font-bold mb-4">$89.99<span class="text-lg text-gray-600">/yr</span></div>
                    <div class="text-green-500 mb-4">Save 25%</div>
                    <ul class="space-y-2 mb-6">
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            Unlimited prompts
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            Priority support
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            Advanced features
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            Exclusive content
                        </li>
                    </ul>
                    <button onclick="subscribe('yearly')" class="w-full bg-gradient-to-r from-izzy-purple-500 to-izzy-pink-500 text-white py-3 rounded-lg hover:opacity-90 transition-opacity">
                        Subscribe Yearly
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Referral Modal -->
<div id="referral-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="container mx-auto px-4 h-full flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full relative">
            <button onclick="closeReferralModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h2 class="text-2xl font-bold mb-6 text-center">Invite Friends</h2>
            <div class="gradient-bg rounded-xl p-6 mb-6">
                <h3 class="text-lg font-bold mb-2">Your Referral Link</h3>
                <div class="flex items-center space-x-2">
                    <input type="text" id="referral-link" readonly class="flex-1 p-2 border rounded-lg bg-white" value="">
                    <button onclick="copyReferralLink()" class="bg-izzy-purple-500 text-white px-4 py-2 rounded-lg hover:bg-izzy-purple-600 transition-colors">
                        Copy
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Friends Invited:</span>
                    <span id="referral-count" class="font-bold">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Rewards Earned:</span>
                    <span id="rewards-earned" class="font-bold">0 prompts</span>
                </div>
            </div>
            <div class="mt-6">
                <h3 class="text-lg font-bold mb-4">How it works:</h3>
                <ul class="space-y-2">
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                        <span>Share your unique referral link with friends</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                        <span>Get 5 free prompts when your first friend joins</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                        <span>Earn 10 more prompts at 2 friends</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                        <span>Get 20 bonus prompts at 3 friends</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

<!-- Auth Modal -->
<div id="authModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-50 p-4">
  <div class="bg-white rounded-3xl shadow-2xl p-6 sm:p-8 max-w-md w-full fade-in">
    <div class="flex justify-center mb-6">
      <div class="bg-gradient-to-r from-izzy-pink-500 to-izzy-purple-500 rounded-full w-16 h-16 flex items-center justify-center">
        <span class="text-white text-2xl font-bold">IZZY</span>
      </div>
    </div>
    <div class="text-center mb-8">
      <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900">Real Conversations.</h1>
      <h2 class="text-2xl sm:text-3xl font-semibold text-gray-900 mb-4">Real Confidence.</h2>
      <p class="text-gray-600">Please log in or sign up to continue.</p>
    </div>

    <button id="google-signin-btn"
      class="w-full flex items-center justify-center border border-gray-300 rounded-full py-3 mb-4 hover:bg-gray-50 transition-colors duration-200">
      <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.1H42V20H24v8h11.3c-1.6 4.7-6.1 8-11.3 8-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.8 1.2 8 3l5.7-5.7C34 6 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.6-.4-3.9z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 15.1 19 12 24 12c3.1 0 5.8 1.2 8 3l5.7-5.7C34 6 29.3 4 24 4c-7.7 0-14.4 4.3-17.7 10.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-2 13.4-5.2l-6.2-5.2C29.2 35.1 26.7 36 24 36c-5.2 0-9.6-3.3-11.3-7.9l-6.5 5C9.5 39.6 16.2 44 24 44z"/><path fill="#1976D2" d="M43.6 20.1H42V20H24v8h11.3c-.8 2.2-2.2 4.2-4.1 5.6l6.2 5.2C37 39.2 44 34 44 24c0-1.3-.1-2.6-.4-3.9z"/></svg>
      <span class="text-gray-700 font-medium">Continue with Google</span>
    </button>

    <div class="flex items-center text-gray-500 text-sm my-4">
      <div class="flex-1 border-t border-gray-300"></div>
      <span class="px-3">OR</span>
      <div class="flex-1 border-t border-gray-300"></div>
    </div>

    <form id="email-form" onsubmit="sendMagicLink(event)">
      <label for="email" class="sr-only">Email address</label>
      <input type="email" 
             id="email"
             name="email"
             placeholder="Enter your email"
             aria-label="Email address"
             class="w-full px-4 py-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-izzy-purple-500 mb-3"
             required />
      <button type="submit"
              class="w-full py-3 rounded-full text-white font-semibold bg-gradient-to-r from-izzy-purple-500 to-izzy-pink-500 hover:opacity-90 transition-all duration-300 flex items-center justify-center">
        <span class="email-btn-text">Send Magic Link</span>
        <span class="spinner hidden"></span>
      </button>
    </form>

    <div id="auth-status-message" class="text-center text-sm mt-3 min-h-[1.2em]"></div>

    <p class="text-center text-xs text-gray-500 mt-4">
      By continuing, you agree to our
      <a href="#terms" class="text-izzy-purple-500 hover:underline">Terms</a> & 
      <a href="#privacy" class="text-izzy-purple-500 hover:underline">Privacy</a>.
    </p>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
// Initialize Firebase first
const firebaseConfig = {
  apiKey: "AIzaSyBlmM-6P2WHj59R5FAvFy6ZjIDA637f7p4",
  authDomain: "izzy-auth.firebaseapp.com",
  databaseURL: "https://izzy-auth-default-rtdb.firebaseio.com",
  projectId: "izzy-auth",
  storageBucket: "izzy-auth.appspot.com",
  messagingSenderId: "573135779043",
  appId: "1:573135779043:web:f6c59473f9956c917041d6",
  measurementId: "G-8JLKB2MMKS"
};

// Initialize Firebase
let auth;
let db;

try {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.database();
    console.log("Firebase initialized successfully");
} catch (e) {
    console.error("Firebase initialization failed:", e);
    showToast("Application could not load. Please check console or refresh.", true);
}

// Initialize state variables
let currentUser = null;
let currentUserId = null;
let currentConversationId = null;
let promptsLeft = FREE_PROMPT_LIMIT;
let promptsUsed = 0;
let isSubscribed = false;
let successfulReferralCount = 0;

// Handle Magic Link Sign-in on page load
function handleMagicLinkSignIn() {
    if (auth.isSignInWithEmailLink(window.location.href)) {
        let email = localStorage.getItem('emailForSignIn');
        if (!email) {
            email = window.prompt('Please provide your email for confirmation');
        }
        
        if (email) {
            const statusMessage = document.getElementById('auth-status-message');
            if (statusMessage) {
                statusMessage.textContent = "Signing you in...";
                statusMessage.classList.add('text-izzy-purple-500');
            }
            
            auth.signInWithEmailLink(email, window.location.href)
                .then(() => {
                    localStorage.removeItem('emailForSignIn');
                    showToast('Successfully signed in!', false);
                    // Remove the sign-in link from the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Hide auth modal after successful sign-in
                    const authModal = document.getElementById('authModal');
                    if (authModal) {
                        authModal.classList.add('hidden');
                    }
                })
                .catch((error) => {
                    console.error('Error signing in with email link:', error);
                    showToast(error.message || 'Error signing in. Please try again.', true);
                    if (statusMessage) {
                        statusMessage.textContent = "Sign-in failed. Please try again.";
                        statusMessage.classList.add('text-red-500');
                    }
                });
        }
    }
}

// Updated Magic Link Sign-in Function
function sendMagicLink(event) {
    event.preventDefault();
    
    const emailInput = document.getElementById('email');
    const email = emailInput.value.trim();
    
    if (!email) {
        showToast("Please enter your email address.", true);
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showToast("Please enter a valid email address.", true);
        return;
    }
    
    const submitBtn = document.querySelector('#email-form button[type="submit"]');
    const btnText = submitBtn.querySelector('.email-btn-text');
    const spinner = submitBtn.querySelector('.spinner');
    
    showButtonLoading(submitBtn, btnText, spinner, true);
    
    // Store email for later use
    localStorage.setItem('emailForSignIn', email);
    
    const actionCodeSettings = {
        url: window.location.href,
        handleCodeInApp: true
    };
    
    auth.sendSignInLinkToEmail(email, actionCodeSettings)
        .then(() => {
            showToast(`Magic link sent to ${email}! Check your inbox.`, false);
            emailInput.value = '';
            // Show status message in the auth modal
            const statusMessage = document.getElementById('auth-status-message');
            if (statusMessage) {
                statusMessage.textContent = "Check your email for the magic link!";
                statusMessage.classList.add('text-izzy-purple-500');
                statusMessage.classList.remove('text-red-500');
            }
        })
        .catch((error) => {
            console.error("Error sending magic link:", error);
            let errorMessage = "Error sending sign-in link. Please try again.";
            if (error.code === 'auth/invalid-email') {
                errorMessage = "Please enter a valid email address.";
            } else if (error.code === 'auth/missing-android-pkg-name') {
                errorMessage = "Please try signing in with Google instead.";
            }
            showToast(errorMessage, true);
            // Show error in the auth modal
            const statusMessage = document.getElementById('auth-status-message');
            if (statusMessage) {
                statusMessage.textContent = errorMessage;
                statusMessage.classList.remove('text-izzy-purple-500');
                statusMessage.classList.add('text-red-500');
            }
        })
        .finally(() => {
            showButtonLoading(submitBtn, btnText, spinner, false);
        });
}

// Updated Google Sign-in Function
function signInWithGoogle() {
    if (!auth) {
        console.error("Firebase Auth not initialized");
        showToast("Authentication service not ready. Please try again.", true);
        return;
    }

    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({
        prompt: 'select_account'
    });
    
    const googleBtn = document.getElementById('google-signin-btn');
    if (googleBtn) {
        googleBtn.disabled = true;
        googleBtn.classList.add('opacity-75');
    }

    auth.signInWithPopup(provider)
        .then((result) => {
            console.log("Google sign-in successful");
            showToast("Successfully signed in with Google!", false);
            // Hide auth modal after successful sign-in
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.classList.add('hidden');
            }
            // Initialize user data if new user
            if (result.additionalUserInfo.isNewUser) {
                initializeNewUser(result.user);
            }
        })
        .catch((error) => {
            console.error("Google sign-in error:", error);
            let errorMessage = "Google sign-in failed. Please try again.";
            
            if (error.code === 'auth/popup-blocked') {
                errorMessage = "Sign-in popup was blocked. Please allow popups and try again.";
            } else if (error.code === 'auth/popup-closed-by-user') {
                errorMessage = "Sign-in was cancelled. Please try again.";
            } else if (error.code === 'auth/auth-domain-config-required') {
                errorMessage = "Please make sure you're using the correct domain for authentication.";
            }
            
            showToast(errorMessage, true);
            const statusMessage = document.getElementById('auth-status-message');
            if (statusMessage) {
                statusMessage.textContent = errorMessage;
                statusMessage.classList.add('text-red-500');
            }
        })
        .finally(() => {
            if (googleBtn) {
                googleBtn.disabled = false;
                googleBtn.classList.remove('opacity-75');
            }
        });
}

// Initialize new user data
function initializeNewUser(user) {
    const initialData = {
        email: user.email || 'Not Provided',
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        conversations: 0,
        promptsUsed: 0,
        promptsLeft: FREE_PROMPT_LIMIT,
        level: 'Beginner',
        subscribed: false,
        currentConversationId: null,
        successfulReferralCount: 0
    };

    return db.ref(`users/${user.uid}`).set(initialData)
        .then(() => {
            console.log("New user data initialized");
            // Check for referral
            const referrerId = localStorage.getItem(LS_KEY_REFERRER);
            if (referrerId && referrerId !== user.uid) {
                handleSuccessfulReferral(referrerId);
            }
        })
        .catch(error => {
            console.error("Error initializing user data:", error);
            showToast("Error setting up your account. Some features may be limited.", true);
        });
}

// Handle successful referral
function handleSuccessfulReferral(referrerId) {
    const referralRef = db.ref(`users/${referrerId}`);
    referralRef.transaction((userData) => {
        if (userData) {
            const currentCount = (userData.successfulReferralCount || 0) + 1;
            userData.successfulReferralCount = currentCount;
            // Grant bonus prompts based on referral tier
            if (currentCount <= MAX_REFERRALS_REWARDED) {
                grantReferralBonusPrompts(referrerId, currentCount);
            }
        }
        return userData;
    });
}

// Constants
const FREE_PROMPT_LIMIT = 3;
const MAX_REFERRALS_REWARDED = 3; // Max referrals that grant rewards
// Defines the *additional* prompts awarded when reaching *each* tier
const REFERRAL_PROMPTS_TIERS = { 1: 5, 2: 10, 3: 20 };
const REFERRAL_COOLDOWN_DAYS = 7; // Days between referral rewards

// Local Storage Keys
const LS_KEY_PROMPTS = 'izzy_prompts_left_backup';
const LS_KEY_CHAT = 'izzy_chat_history_backup';
const LS_KEY_REFERRER = 'storedInviterUid'; // Stores potential referrer on visit
const LS_KEY_REFERRAL_VISITED_PREFIX = 'visitedAsReferral_'; // Tracks visits per referrer link
const LS_KEY_LAST_REFERRAL_REWARD = 'last_referral_reward_timestamp'; // Tracks when last reward was given

// Add these constants at the top of your script
const MAX_CONTEXT_LENGTH = 5; // Number of previous messages to keep in context
const MOBILE_GESTURE_THRESHOLD = 50; // Minimum distance for swipe gesture

// Add these to your existing state management
let conversationContext = [];
let lastMessageTime = null;
let isMobile = window.innerWidth <= 768;

// Mobile menu state
let touchStartX = 0;
let touchEndX = 0;

function sendMessage() {
    const messageText = domElements.userInput.value.trim();
    if (!messageText) return;
    if (!currentUser || !currentUserId) { return; }

    // Check if user has prompts left or is subscribed
    if (!isSubscribed && promptsLeft <= 0) {
        openSubscribeModal();
        showToast("You've used all your free prompts. Subscribe to continue chatting!", true);
        return;
    }

    showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, true);
    addMessageToHistory(messageText, 'user');

    // Create new conversation if needed
    if (!currentConversationId) {
        currentConversationId = db.ref(`chats/${currentUserId}`).push().key;
        updateUserData(currentUserId, { 
            currentConversationId: currentConversationId, 
            conversations: firebase.database.ServerValue.increment(1) 
        }).catch(err => console.error("Failed to update conversation ID/count:", err));
    }

    // Save user message
    saveMessage(currentUserId, currentConversationId, messageText, 'user')
        .catch(error => {
            console.error("Failed to save user message:", error);
            showToast("Error sending message. Please try again.", true);
        });

    // Simulate AI Response
    const simulateApiCall = new Promise((resolve) => {
        setTimeout(() => {
            const responses = [
                "That's interesting! Tell me more.",
                "Okay, I see. What happened next?",
                "How did that make you feel?",
                "Hmm, let's think about that.",
                "Got it. What's on your mind now?",
                "Can you elaborate on that point?",
                "What are your thoughts on trying this approach...?"
            ];
            resolve(responses[Math.floor(Math.random() * responses.length)]);
        }, 1500);
    });

    simulateApiCall
        .then(aiResponse => {
            addMessageToHistory(aiResponse, 'assistant');
            return saveMessage(currentUserId, currentConversationId, aiResponse, 'assistant');
        })
        .then(() => {
            // Only decrement prompts if user is not subscribed
            if (!isSubscribed) {
                return db.ref(`users/${currentUserId}`).transaction(userData => {
                    if (userData) {
                        // Decrement prompts left and increment prompts used
                        userData.promptsLeft = Math.max(0, (userData.promptsLeft || 0) - 1);
                        userData.promptsUsed = (userData.promptsUsed || 0) + 1;
                        
                        // Update local variables
                        promptsLeft = userData.promptsLeft;
                        promptsUsed = userData.promptsUsed;
                        
                        // Save timestamp with prompts to localStorage to prevent stale data
                        localStorage.setItem(LS_KEY_PROMPTS, JSON.stringify({
                            count: promptsLeft,
                            timestamp: Date.now()
                        }));
                        
                        // Show subscription modal if this was the last free prompt
                        if (promptsLeft === 0) {
                            // Delay the modal to allow the user to see the AI response first
                            setTimeout(() => {
                                openSubscribeModal();
                                showToast("You've used all your free prompts. Subscribe to continue chatting!", true);
                            }, 2000);
                        } else if (promptsLeft === 1) {
                            // Show a warning toast when only 1 prompt is left
                            showToast("You have 1 free prompt left. Subscribe for unlimited access!", false);
                        }
                    }
                    return userData;
                });
            }
            return Promise.resolve();
        })
        .then((result) => {
            if (!isSubscribed && result && result.committed) {
                // Update UI with new prompt counts
                updatePromptsUI();
                checkSubscriptionStatus();
            }
        })
        .catch(error => {
            console.error("Error processing/saving AI response or updating prompts:", error);
            showToast("Error getting response. Please try again.", true);
            addMessageToHistory("Sorry, I encountered an error.", 'assistant');
        })
        .finally(() => {
            showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, false);
            domElements.userInput.value = '';
            domElements.userInput.focus();
        });
}

function updatePromptsUI() {
    if (!domElements.promptsLeftEl || !domElements.promptsWarning || !domElements.promptsWarningCount) return;
    
    // Update prompts left display
    domElements.promptsLeftEl.textContent = isSubscribed ? '∞' : promptsLeft;
    
    // Update progress bar if it exists
    if (domElements.promptsProgressBar) {
      const totalPrompts = FREE_PROMPT_LIMIT;
      const usedPrompts = totalPrompts - promptsLeft;
      const percentage = Math.min(100, (usedPrompts / totalPrompts) * 100);
      
      domElements.promptsProgressBar.style.width = `${percentage}%`;
      
      // Change color based on remaining prompts
      if (promptsLeft === 0) {
        domElements.promptsProgressBar.classList.remove('bg-yellow-500', 'bg-green-500');
        domElements.promptsProgressBar.classList.add('bg-red-500');
      } else if (promptsLeft === 1) {
        domElements.promptsProgressBar.classList.remove('bg-green-500', 'bg-red-500');
        domElements.promptsProgressBar.classList.add('bg-yellow-500');
      } else {
        domElements.promptsProgressBar.classList.remove('bg-yellow-500', 'bg-red-500');
        domElements.promptsProgressBar.classList.add('bg-green-500');
      }
    }
    
    // Show warning when prompts are running low
    if (!isSubscribed && promptsLeft <= 1 && promptsLeft >= 0) {
        domElements.promptsWarning.classList.remove('hidden');
        domElements.promptsWarningCount.textContent = promptsLeft;
        
        // Add visual emphasis to the warning
        domElements.promptsWarning.classList.add('text-red-600', 'font-bold');
        
        // Add animation for emphasis
        domElements.promptsWarning.classList.add('animate-pulse');
    } else {
        domElements.promptsWarning.classList.add('hidden');
        domElements.promptsWarning.classList.remove('text-red-600', 'font-bold', 'animate-pulse');
    }
    
    // Update send button state
    checkSubscriptionStatus();
}

function checkSubscriptionStatus() {
    if (!domElements.sendButton) return;
    
    if (!isSubscribed && promptsLeft <= 0) {
        disableSendButton();
    } else {
        enableSendButton();
    }
}

function grantReferralBonusPrompts(inviterUid, newRefCount) {
    // Check if the user has already reached the maximum reward tier
    if (newRefCount > MAX_REFERRALS_REWARDED) {
        console.log(`Inviter ${inviterUid} has already reached max referral rewards.`);
        return;
    }
    
    // Check for cooldown period
    const lastRewardTimestamp = localStorage.getItem(LS_KEY_LAST_REFERRAL_REWARD);
    if (lastRewardTimestamp) {
        const lastRewardDate = new Date(parseInt(lastRewardTimestamp));
        const now = new Date();
        const daysSinceLastReward = Math.floor((now - lastRewardDate) / (1000 * 60 * 60 * 24));
        
        if (daysSinceLastReward < REFERRAL_COOLDOWN_DAYS) {
            console.log(`Referral reward on cooldown. ${REFERRAL_COOLDOWN_DAYS - daysSinceLastReward} days remaining.`);
            return;
        }
    }

    // Get the specific bonus amount for reaching this tier
    const promptsToAdd = REFERRAL_PROMPTS_TIERS[newRefCount];

    if (!promptsToAdd) {
        console.log(`No specific prompt reward defined for reaching ${newRefCount} referrals.`);
        return;
    }

    console.log(`Attempting to grant ${promptsToAdd} bonus prompts to inviter ${inviterUid} for reaching ${newRefCount} referrals.`);

    const inviterUserRef = db.ref(`users/${inviterUid}`);

    // Use a transaction to safely add prompts to the inviter's count
    inviterUserRef.child('promptsLeft').transaction(currentPrompts => {
        // Ensure we handle null/undefined cases for promptsLeft
        const currentVal = (typeof currentPrompts === 'number') ? currentPrompts : 0;
        // Add the bonus prompts for reaching this tier
        return currentVal + promptsToAdd;
    }).then((result) => {
        if (result.committed) {
            const finalPromptCount = result.snapshot.val();
            console.log(`Granted ${promptsToAdd} bonus prompts to inviter ${inviterUid}. New total: ${finalPromptCount}`);
            
            // Update local variables if this is the current user
            if (inviterUid === currentUserId) {
                promptsLeft = finalPromptCount;
                updatePromptsUI();
                
                // Save timestamp with prompts to localStorage
                localStorage.setItem(LS_KEY_PROMPTS, JSON.stringify({
                    count: promptsLeft,
                    timestamp: Date.now()
                }));
                
                // Record the reward timestamp
                localStorage.setItem(LS_KEY_LAST_REFERRAL_REWARD, Date.now().toString());
            }
            
            // Push a notification to the inviter
            db.ref(`notifications/${inviterUid}`).push({
                type: 'referral_bonus',
                message: `You earned ${promptsToAdd} free prompts for referring your ${getOrdinal(newRefCount)} friend!`,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            });
            
            // Show toast notification
            showToast(`Congratulations! You earned ${promptsToAdd} free prompts!`, false);
        } else {
            console.log(`Transaction to add bonus prompts for inviter ${inviterUid} aborted (maybe concurrent update?).`);
        }
    }).catch(error => {
        console.error(`Error granting bonus prompts to inviter ${inviterUid}:`, error);
    });
}

function loadUserData(userId) {
    showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, true);
    const userRef = db.ref(`users/${userId}`);
    userRef.once('value')
        .then(snapshot => {
            const userData = snapshot.val();
            if (userData) {
                // User exists, load their data
                console.log("Loaded user data:", userData);
                promptsUsed = userData.promptsUsed || 0;
                // Load promptsLeft, ensure it's a number, default to FREE_LIMIT if missing/invalid
                promptsLeft = (typeof userData.promptsLeft === 'number') ? Math.max(0, userData.promptsLeft) : FREE_PROMPT_LIMIT;
                isSubscribed = userData.subscribed || false;
                currentConversationId = userData.currentConversationId || null;
                // Load successful referral count
                successfulReferralCount = userData.successfulReferralCount || 0;

                // Update UI Stats
                if (domElements.conversationCountEl) domElements.conversationCountEl.textContent = userData.conversations || 0;
                if (domElements.skillLevelEl) domElements.skillLevelEl.textContent = userData.level || 'Beginner';

                // Load chat history
                loadChatHistory(userId, currentConversationId);

            } else {
                // New user, initialize their data
                console.log("New user detected, initializing data for:", userId);
                const initialData = {
                    email: currentUser.email || 'Not Provided',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    conversations: 0, promptsUsed: 0, promptsLeft: FREE_PROMPT_LIMIT,
                    level: 'Beginner', subscribed: false, currentConversationId: null,
                    successfulReferralCount: 0 // Initialize referral count
                };
                userRef.set(initialData)
                    .then(() => {
                        console.log("Initial user data saved.");
                        // Set initial state variables after saving defaults
                        promptsLeft = FREE_PROMPT_LIMIT;
                        successfulReferralCount = 0;
                        isSubscribed = false;
                        currentConversationId = null;
                        promptsUsed = 0;
                        // Update UI based on these initial values
                        updatePromptsUI();
                        checkSubscriptionStatus();
                        updateShareSectionUI();
                        resetAppState(); // Reset UI elements like chat
                    })
                    .catch(error => console.error("Error saving initial user data:", error));
                 // Don't proceed with UI updates until data is potentially saved
                 return; // Exit early, UI will update after save or on error
            }

            // Update UI based on loaded/initialized data
            updatePromptsUI();
            checkSubscriptionStatus();
            updateShareSectionUI(); // Update share section based on referral count

        })
        .catch(error => {
            console.error("Error loading user data:", error);
            showToast("Error loading your data. Using defaults.", true);
            resetAppState(); // Fallback to default state
            updateShareSectionUI(); // Update share section for error state
        })
        .finally(() => {
            // Ensure loading indicator is hidden even if new user init happened
            showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, false);
        });
}

document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM fully loaded and parsed");

    // Cache DOM elements needed by scripts
    cacheDomElements();

    // Check for magic link sign-in attempt immediately
    handleMagicLinkSignIn();

    // Add all event listeners
    addEventListeners();

    // Call referral visit handler
    handleReferralVisit();

    // Initial UI updates are handled by onAuthStateChanged listener

    // Load data from localStorage backups if available (useful for offline/refresh before DB loads)
    try {
        const localPromptsData = localStorage.getItem(LS_KEY_PROMPTS);
        if (localPromptsData) {
            const parsedData = JSON.parse(localPromptsData);
            // Check if data is less than 24 hours old
            if (parsedData.timestamp && (Date.now() - parsedData.timestamp < 24 * 60 * 60 * 1000)) {
                promptsLeft = parsedData.count;
                console.log("Restored prompts left from localStorage:", promptsLeft);
                updatePromptsUI();
            } else {
                console.log("LocalStorage prompt data is too old, ignoring");
            }
        }
    } catch (e) {
        console.error("Error parsing localStorage prompt data:", e);
    }
    
    const localChat = JSON.parse(localStorage.getItem(LS_KEY_CHAT) || '[]');
     if (localChat.length > 0 && domElements.chatContainer && domElements.chatContainer.children.length === 0) {
        console.log("Restoring chat from localStorage backup.");
        localChat.forEach(msg => addMessageToHistory(msg.text, msg.sender));
     }
});

function cacheDomElements() {
    domElements = {
        // ... existing elements ...
        promptsProgressBar: document.getElementById('prompts-progress-bar'),
        // ... existing elements ...
    };
}

// Add these functions after your existing functions
function saveConversationContext() {
    if (conversationContext.length > 0) {
        localStorage.setItem('conversationContext', JSON.stringify(conversationContext));
    }
}

function loadConversationContext() {
    const savedContext = localStorage.getItem('conversationContext');
    if (savedContext) {
        conversationContext = JSON.parse(savedContext);
    }
}

function updateConversationContext(message, isUser = true) {
    const timestamp = new Date().toISOString();
    conversationContext.push({
        message,
        isUser,
        timestamp
    });
    
    // Keep only the last MAX_CONTEXT_LENGTH messages
    if (conversationContext.length > MAX_CONTEXT_LENGTH) {
        conversationContext = conversationContext.slice(-MAX_CONTEXT_LENGTH);
    }
    
    saveConversationContext();
}

function getContextualResponse(userMessage) {
    // Add conversation context to the prompt
    let contextPrompt = '';
    if (conversationContext.length > 0) {
        contextPrompt = 'Previous conversation:\n';
        conversationContext.forEach(msg => {
            contextPrompt += `${msg.isUser ? 'User' : 'IZZY'}: ${msg.message}\n`;
        });
        contextPrompt += '\nCurrent message:\n';
    }
    
    // Add time-based context
    if (lastMessageTime) {
        const timeDiff = (new Date() - new Date(lastMessageTime)) / 1000 / 60; // in minutes
        if (timeDiff > 30) {
            contextPrompt += '\nNote: There was a significant gap in the conversation.\n';
        }
    }
    
    lastMessageTime = new Date().toISOString();
    
    // Combine context with user message
    return contextPrompt + userMessage;
}

// Mobile menu state
let isMobileMenuOpen = false;

function toggleMobileMenu() {
    const mobileMenu = document.querySelector('.mobile-menu');
    const overlay = document.querySelector('.mobile-menu-overlay');
    
    isMobileMenuOpen = !isMobileMenuOpen;
    
    if (isMobileMenuOpen) {
        mobileMenu.classList.remove('hidden');
        setTimeout(() => {
            mobileMenu.classList.add('slide-in');
            overlay.classList.add('visible');
        }, 10);
    } else {
        mobileMenu.classList.remove('slide-in');
        mobileMenu.classList.add('slide-out');
        overlay.classList.remove('visible');
        
        setTimeout(() => {
            mobileMenu.classList.add('hidden');
            mobileMenu.classList.remove('slide-out');
        }, 300);
    }
}

function handleSwipe(e) {
    touchStartX = e.touches[0].clientX;
}

function handleSwipeEnd(e) {
    touchEndX = e.changedTouches[0].clientX;
    const swipeDistance = touchEndX - touchStartX;
    
    if (Math.abs(swipeDistance) > 50) {
        if (swipeDistance > 0 && !isMobileMenuOpen) {
            toggleMobileMenu();
        } else if (swipeDistance < 0 && isMobileMenuOpen) {
            toggleMobileMenu();
        }
    }
}

function updateMobileView() {
    const isMobile = window.innerWidth <= 768;
    const chatContainer = document.querySelector('.chat-container');
    
    if (isMobile) {
        chatContainer.style.height = 'calc(100vh - 120px)';
    } else {
        chatContainer.style.height = 'calc(100vh - 80px)';
    }
}

// Add event listeners for mobile menu
document.addEventListener('DOMContentLoaded', () => {
    const mobileMenu = document.querySelector('.mobile-menu');
    const overlay = document.querySelector('.mobile-menu-overlay');
    
    // Touch events for swipe
    document.addEventListener('touchstart', handleSwipe);
    document.addEventListener('touchend', handleSwipeEnd);
    
    // Close menu when clicking overlay
    overlay.addEventListener('click', toggleMobileMenu);
    
    // Handle window resize
    window.addEventListener('resize', updateMobileView);
    updateMobileView();
    
    // Close menu when clicking menu items
    const menuItems = document.querySelectorAll('.mobile-menu-item');
    menuItems.forEach(item => {
        item.addEventListener('click', () => {
            if (isMobileMenuOpen) {
                toggleMobileMenu();
            }
        });
    });
});

// UI Component Functions
function showToast(message, isError = false) {
    const toast = document.createElement('div');
    toast.className = `toast ${isError ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg mb-2 transform transition-all duration-300 opacity-0 translate-y-4`;
    toast.textContent = message;
    
    const container = document.getElementById('toast-container');
    container.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-4');
        toast.classList.add('opacity-100', 'translate-y-0');
    }, 10);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-4');
        setTimeout(() => container.removeChild(toast), 300);
    }, 3000);
}

function openSubscribeModal() {
    const modal = document.getElementById('subscription-modal');
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
}

function closeSubscribeModal() {
    const modal = document.getElementById('subscription-modal');
    modal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}

function openReferralModal() {
    const modal = document.getElementById('referral-modal');
    const referralLink = document.getElementById('referral-link');
    const referralCount = document.getElementById('referral-count');
    const rewardsEarned = document.getElementById('rewards-earned');
    
    // Update referral link
    const baseUrl = window.location.origin + window.location.pathname;
    referralLink.value = `${baseUrl}?ref=${currentUserId}`;
    
    // Update counts
    referralCount.textContent = successfulReferralCount;
    const totalRewards = calculateTotalRewards(successfulReferralCount);
    rewardsEarned.textContent = `${totalRewards} prompts`;
    
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
}

function closeReferralModal() {
    const modal = document.getElementById('referral-modal');
    modal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}

function copyReferralLink() {
    const referralLink = document.getElementById('referral-link');
    referralLink.select();
    document.execCommand('copy');
    showToast('Referral link copied to clipboard!');
}

function calculateTotalRewards(referralCount) {
    let total = 0;
    for (let i = 1; i <= Math.min(referralCount, MAX_REFERRALS_REWARDED); i++) {
        total += REFERRAL_PROMPTS_TIERS[i] || 0;
    }
    return total;
}

function subscribe(plan) {
    if (!currentUser) {
        showToast('Please sign in to subscribe', true);
        return;
    }
    
    // Here you would integrate with your payment processor
    // For now, we'll simulate a successful subscription
    showButtonLoading(domElements.subscribeButton, domElements.subscribeButtonText, domElements.subscribeButtonSpinner, true);
    
    setTimeout(() => {
        db.ref(`users/${currentUserId}`).update({
            subscribed: true,
            subscriptionPlan: plan,
            subscriptionDate: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            isSubscribed = true;
            closeSubscribeModal();
            showToast('Successfully subscribed! Enjoy unlimited prompts!');
            updatePromptsUI();
        }).catch(error => {
            console.error('Subscription error:', error);
            showToast('Error processing subscription. Please try again.', true);
        }).finally(() => {
            showButtonLoading(domElements.subscribeButton, domElements.subscribeButtonText, domElements.subscribeButtonSpinner, false);
        });
    }, 1500);
}

function showButtonLoading(button, textElement, spinnerElement, isLoading) {
    if (!button || !textElement || !spinnerElement) return;
    
    if (isLoading) {
        button.disabled = true;
        textElement.classList.add('hidden');
        spinnerElement.classList.remove('hidden');
    } else {
        button.disabled = false;
        textElement.classList.remove('hidden');
        spinnerElement.classList.add('hidden');
    }
}

function addMessageToHistory(message, sender) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-bubble ${sender}-bubble`;
    messageDiv.textContent = message;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Save to localStorage backup
    const localChat = JSON.parse(localStorage.getItem(LS_KEY_CHAT) || '[]');
    localChat.push({ text: message, sender });
    localStorage.setItem(LS_KEY_CHAT, JSON.stringify(localChat));
}

function clearConversation() {
    if (!confirm('Are you sure you want to clear the conversation?')) return;
    
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = '';
    localStorage.removeItem(LS_KEY_CHAT);
    
    // Create new conversation
    if (currentUserId) {
        currentConversationId = db.ref(`chats/${currentUserId}`).push().key;
        updateUserData(currentUserId, { 
            currentConversationId: currentConversationId,
            conversations: firebase.database.ServerValue.increment(1)
        }).catch(err => console.error("Failed to update conversation:", err));
    }
    
    showToast('Conversation cleared');
}

function updateShareSectionUI() {
    const shareSection = document.querySelector('.share-section');
    if (!shareSection) return;
    
    if (successfulReferralCount >= MAX_REFERRALS_REWARDED) {
        shareSection.classList.add('disabled');
        shareSection.querySelector('button').disabled = true;
        shareSection.querySelector('.share-button').classList.add('opacity-50');
    } else {
        shareSection.classList.remove('disabled');
        shareSection.querySelector('button').disabled = false;
        shareSection.querySelector('.share-button').classList.remove('opacity-50');
    }
}

// Cache DOM elements
let domElements = {
    userInput: document.getElementById('user-input'),
    sendButton: document.getElementById('send-button'),
    sendButtonText: document.getElementById('send-button-text'),
    sendButtonSpinner: document.getElementById('send-button-spinner'),
    chatMessages: document.getElementById('chat-messages'),
    promptsLeftEl: document.getElementById('prompts-left'),
    promptsWarning: document.getElementById('prompts-warning'),
    promptsWarningCount: document.getElementById('prompts-warning-count'),
    promptsProgressBar: document.getElementById('prompts-progress-bar'),
    conversationCountEl: document.getElementById('conversation-count'),
    subscribeButton: document.querySelector('[onclick^="subscribe"]'),
    subscribeButtonText: document.querySelector('[onclick^="subscribe"] span'),
    subscribeButtonSpinner: document.querySelector('[onclick^="subscribe"] .spinner')
};

// Add missing functions
function resetAppState() {
    // Reset all state variables
    currentConversationId = null;
    promptsLeft = FREE_PROMPT_LIMIT;
    promptsUsed = 0;
    isSubscribed = false;
    successfulReferralCount = 0;
    
    // Clear chat history
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.innerHTML = '';
    }
    
    // Reset UI elements
    updatePromptsUI();
    updateShareSectionUI();
    
    // Clear localStorage
    localStorage.removeItem(LS_KEY_CHAT);
    localStorage.removeItem(LS_KEY_PROMPTS);
}

function handleReferralVisit(referrerId) {
    if (!referrerId) {
        const urlParams = new URLSearchParams(window.location.search);
        referrerId = urlParams.get('ref');
    }
    
    if (referrerId) {
        localStorage.setItem(LS_KEY_REFERRER, referrerId);
        const visitKey = `${LS_KEY_REFERRAL_VISITED_PREFIX}${referrerId}`;
        if (!localStorage.getItem(visitKey)) {
            localStorage.setItem(visitKey, Date.now().toString());
        }
    }
}

function addEventListeners() {
    // Email form submission
    const emailForm = document.getElementById('email-form');
    if (emailForm) {
        emailForm.addEventListener('submit', sendMagicLink);
    }
    
    // Google sign-in button
    const googleBtn = document.getElementById('google-signin-btn');
    if (googleBtn) {
        googleBtn.addEventListener('click', signInWithGoogle);
    }
    
    // Message input
    const userInput = document.getElementById('user-input');
    if (userInput) {
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
}

function enableSendButton() {
    if (!domElements.sendButton) return;
    domElements.sendButton.disabled = false;
    domElements.sendButton.classList.remove('opacity-50');
}

function disableSendButton() {
    if (!domElements.sendButton) return;
    domElements.sendButton.disabled = true;
    domElements.sendButton.classList.add('opacity-50');
}

function getOrdinal(n) {
    const s = ["th", "st", "nd", "rd"];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function updateUserData(userId, updates) {
    return db.ref(`users/${userId}`).update(updates);
}

function saveMessage(userId, conversationId, message, sender) {
    return db.ref(`chats/${userId}/${conversationId}`).push({
        message,
        sender,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
}

function loadChatHistory(userId, conversationId) {
    if (!userId || !conversationId) return;
    
    db.ref(`chats/${userId}/${conversationId}`)
        .orderByChild('timestamp')
        .limitToLast(50)
        .once('value')
        .then(snapshot => {
            const messages = [];
            snapshot.forEach(childSnapshot => {
                const msg = childSnapshot.val();
                messages.push(msg);
            });
            
            // Clear existing messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
                messages.forEach(msg => {
                    addMessageToHistory(msg.message, msg.sender);
                });
            }
        })
        .catch(error => {
            console.error("Error loading chat history:", error);
            showToast("Error loading chat history", true);
        });
}
</script>

</body>
</html> 