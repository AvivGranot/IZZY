<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IZZY – AI Avatar for Real Conversations</title>

  <meta name="description" content="Practice real conversations with IZZY, the AI avatar coach.">
  <meta property="og:image" content="/img/og.png">
  <meta property="og:title" content="IZZY – AI Avatar for Real Conversations">
  <meta property="og:description" content="Practice real conversations with IZZY, the AI avatar coach.">
  <meta property="og:url" content="https://your‑domain.com">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://your‑domain.com/img/og.png">
  <meta property="og:image:alt" content="Screenshot of IZZY AI avatar app">

  <!-- Tailwind Configuration -->
  <script>
    // Extend Tailwind theme with custom colors
    window.tailwindConfig = {
      theme: {
        extend: {
          colors: {
            'izzy-blue': '#0047AB',
            'izzy-purple': {
              500: '#8B5CF6',
              600: '#7C3AED',
              700: '#6D28D9'
            },
            'izzy-pink': {
              500: '#EC4899',
              600: '#DB2777'
            }
          },
        }
      },
    }
  </script>

  <!-- External Resources -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <script>
    // Initialize Tailwind with our config after it loads
    document.addEventListener('DOMContentLoaded', () => {
      if (window.tailwind) {
        window.tailwind.config = window.tailwindConfig;
      }
    });

    // Add resource load error handling
    function handleResourceError(e) {
      console.error('Failed to load resource:', e.target.src || e.target.href);
      const element = document.createElement('div');
      element.style.position = 'fixed';
      element.style.top = '0';
      element.style.left = '0';
      element.style.right = '0';
      element.style.backgroundColor = '#ef4444';
      element.style.color = 'white';
      element.style.padding = '1rem';
      element.style.textAlign = 'center';
      element.style.zIndex = '9999';
      element.textContent = 'Failed to load some resources. Please refresh the page.';
      document.body.prepend(element);
    }

    // Add error handlers to all external resources
    window.addEventListener('load', () => {
      document.querySelectorAll('link[rel="stylesheet"], script[src]').forEach(el => {
        el.addEventListener('error', handleResourceError);
      });
    });
  </script>

  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #fff;
      color: #333;
      line-height: 1.5;
    }

    /* Remove ALL blur effects */
    .glass {
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    /* Clear background blur */
    .blur-background {
      filter: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      background: none !important;
    }

    /* Hero section styles */
    .hero {
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: #fff;
      padding: 2rem;
    }

    .hero h1 {
      font-size: 4rem;
      font-weight: 700;
      color: #000;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-rendering: optimizeLegibility;
    }

    .hero h2 {
      font-size: 2rem;
      color: #666;
      margin-bottom: 2rem;
      text-rendering: optimizeLegibility;
    }

    /* Auth modal styles */
    #authModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .auth-container {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      margin: 1rem;
      z-index: 1001;
    }

    .auth-logo {
      width: auto;
      height: 32px;
      margin: 0 auto 1.5rem;
      display: block;
    }

    .auth-title {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.5rem;
      color: #1a1a1a;
    }

    .auth-subtitle {
      font-size: 16px;
      color: #666;
      text-align: center;
      margin-bottom: 2rem;
    }

    .google-btn {
      width: 100%;
      padding: 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      color: #1a1a1a;
      cursor: pointer;
      transition: all 0.2s;
    }

    .google-btn:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }

    .google-btn img {
      width: 20px;
      height: 20px;
    }

    .divider {
      position: relative;
      text-align: center;
      margin: 1.5rem 0;
    }

    .divider::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #e2e8f0;
    }

    .divider span {
      background: white;
      padding: 0 1rem;
      color: #666;
      position: relative;
    }

    .email-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 16px;
    }

    .email-input:focus {
      outline: none;
      border-color: #8B5CF6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .email-submit {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #8B5CF6, #EC4899);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .email-submit:hover {
      opacity: 0.95;
    }

    .email-submit:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .spinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .spinner.visible {
      display: block;
    }

    .terms {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-top: 1.5rem;
    }

    .terms a {
      color: #8B5CF6;
      text-decoration: none;
    }

    .terms a:hover {
      text-decoration: underline;
    }

    /* Input styles */
    .input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }

    /* Remove any backdrop filters */
    .glass {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    /* Basic Reset & Font */
    * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background: #fff; color:#333; }

    /* Clear any backdrop filters that might cause blur */
    .glass {
      background: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      border: 1px solid rgba(139, 92, 246, 0.1);
    }

    /* Ensure text is sharp */
    .auth-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #333;
      text-rendering: optimizeLegibility;
    }

    .auth-subtitle {
      font-size: 1.1rem;
      color: #666;
      margin-bottom: 2rem;
      text-rendering: optimizeLegibility;
    }

    /* Button styles */
    .google-btn {
      background: white;
      color: #333;
      border: 1px solid #ddd;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-bottom: 1rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .google-btn:hover {
      background: #f8f8f8;
      border-color: #ccc;
    }

    .email-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .email-submit {
      background: linear-gradient(to right, #8B5CF6, #EC4899);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      width: 100%;
      font-weight: 500;
      transition: all 0.2s;
    }

    .email-submit:hover {
      opacity: 0.9;
    }

    /* Backdrop-blur card effect */
    .glass {
      background: rgba(255,255,255,0.85); /* Semi-transparent white */
      backdrop-filter: blur(10px); /* Blur effect */
      -webkit-backdrop-filter: blur(10px); /* Safari support */
      border-radius: 1rem; /* Rounded corners */
      padding: 2rem; /* Padding */
      box-shadow: 0 20px 25px rgba(0,0,0,0.05); /* Subtle shadow */
      border: 1px solid rgba(255, 255, 255, 0.2); /* Optional subtle border */
    }

    /* Blur background behind modals */
    .blur-background { filter: blur(8px); pointer-events:none; }

    /* Simple fade-in animation */
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:none;} }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }

    /* Hidden helper class */
    .visually-hidden { display:none; }

    /* Chat bubble styling */
    .chat-bubble {
      border-radius: 18px; /* Rounded bubbles */
      padding: 10px 15px; /* Padding inside bubbles */
      max-width: 80%; /* Max width to prevent full width */
      margin-bottom: 10px; /* Spacing between bubbles */
      word-wrap: break-word; /* Ensure long words break */
    }
    .user-bubble {
      background-color: #E9F3FF; /* Light blue for user */
      margin-left: auto; /* Align to the right */
      border-bottom-right-radius: 4px; /* Slightly less round corner */
    }
    .assistant-bubble {
      background-color: #F2F2F7; /* Light gray for assistant */
      margin-right: auto; /* Align to the left */
      border-bottom-left-radius: 4px; /* Slightly less round corner */
    }

    /* Focus states for better accessibility */
    button:focus, input:focus, a:focus, iframe:focus, textarea:focus { /* Added textarea */
      outline: 2px solid #8B5CF6; /* Purple outline */
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3); /* Optional softer glow */
    }
    /* Remove default iframe border if focused */
    iframe:focus {
        border: none;
    }


    /* Loading spinner animation */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3); /* Light border */
      border-radius: 50%; /* Circle */
      border-top: 3px solid #8B5CF6; /* Purple top border for spin effect */
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile responsiveness for Navigation */
    @media (max-width: 640px) {
      .mobile-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 100; /* Ensure it's above other content */
        padding: 2rem;
        transform: translateX(-100%); /* Start off-screen */
        transition: transform 0.3s ease;
        display: flex; /* Use flex for layout */
        flex-direction: column; /* Stack items vertically */
      }

      .mobile-menu.open {
        transform: translateX(0); /* Slide in */
      }

      .desktop-nav {
        display: none; /* Hide desktop nav on small screens */
      }

      .mobile-nav-button {
        display: block; /* Show mobile button */
      }
    }

    @media (min-width: 641px) {
      .mobile-nav-button {
        display: none; /* Hide mobile button on large screens */
      }

      .mobile-menu {
        display: none; /* Hide mobile menu */
      }

      .desktop-nav {
        display: flex; /* Show desktop nav */
      }
    }

    /* Styles from subscribe.html */
    .plan-card {
      transition: all 0.3s ease;
    }
    .plan-card:hover {
      transform: translateY(-8px);
    }
    .popular-badge {
      position: absolute;
      top: -12px;
      right: 20px;
      background: linear-gradient(to right, #9333ea, #ec4899);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .gradient-border {
      position: relative;
      border-radius: 1rem;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(to right, #9333ea, #ec4899) border-box;
      border: 2px solid transparent;
    }

    /* Styles from share.html */
    .share-button{transition:all .3s ease}
    .share-button:hover{transform:translateY(-3px)}
    .gradient-card{background:linear-gradient(white,white) padding-box,
                    linear-gradient(to right,#9333ea,#ec4899) border-box;border:2px solid transparent;border-radius:1rem}
    .gradient-bg{background:linear-gradient(135deg,rgba(147,51,234,.08),rgba(236,72,153,.08))}
    .disabled{opacity:.5;cursor:not-allowed !important;transform:none !important}

    .main-content {
      position: relative !important; /* Change from fixed to relative */
      filter: none !important;
      transition: none !important;
    }

    .main-content.authenticated {
      filter: none;
    }

    /* Add this at the beginning of your styles */
    body.pre-auth::before {
        display: none; /* Remove the dark overlay */
    }

    body.pre-auth .content-container {
        filter: none !important; /* Remove blur from content */
    }
    
    body.auth-complete .content-container {
        filter: none;
        transition: filter 0.5s ease;
    }
    
    /* Auth modal styling */
    #authModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
    }
    
    .auth-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        margin: 1rem;
        z-index: 1001;
    }
    
    .auth-logo {
        display: block;
        width: auto;
        height: 40px;
        margin: 0 auto 1.5rem;
    }
    
    .auth-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-align: center;
        color: #1a1a1a;
    }
    
    .auth-subtitle {
        color: #666;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .google-btn {
        width: 100%;
        padding: 0.75rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1.5rem;
    }
    
    .google-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    
    .divider {
        position: relative;
        text-align: center;
        margin: 1.5rem 0;
    }
    
    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e2e8f0;
    }
    
    .divider span {
        position: relative;
        background: white;
        padding: 0 1rem;
        color: #666;
    }
    
    .auth-form {
        margin-bottom: 1.5rem;
    }
    
    .auth-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .auth-input:focus {
        outline: none;
        border-color: #8B5CF6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .auth-button {
        width: 100%;
        padding: 0.75rem;
        background: linear-gradient(135deg, #8B5CF6, #EC4899);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        position: relative;
    }
    
    .auth-button:hover {
        opacity: 0.95;
    }
    
    .auth-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .auth-button .spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: spin 1s linear infinite;
    }
    
    .auth-button .btn-text {
        transition: opacity 0.2s;
    }
    
    .auth-button.loading .btn-text {
        opacity: 0;
    }
    
    .auth-button.loading .spinner {
        display: block;
    }
    
    .auth-status {
        margin-top: 1rem;
        text-align: center;
        font-size: 0.875rem;
    }
    
    .auth-terms {
        text-align: center;
        font-size: 12px;
        color: #666;
        margin-top: 1.5rem;
    }
    
    .auth-terms a {
        color: #8B5CF6;
        text-decoration: none;
    }
    
    .auth-terms a:hover {
        text-decoration: underline;
    }
    
    @keyframes spin {
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Toast notification */
    .toast {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 1rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 300px;
        z-index: 1001;
        transition: transform 0.3s, opacity 0.3s;
        transform: translateY(-10px);
        opacity: 0;
    }
    
    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    
    .toast.success {
        border-left: 4px solid #10B981;
    }
    
    .toast.error {
        border-left: 4px solid #EF4444;
    }

    /* Add these styles at the top of your existing style block */
    
    /* Blurry background before authentication */
    body.unauthenticated .content-wrapper {
      filter: blur(8px);
      transition: filter 0.5s ease-in-out;
    }
    
    body.authenticated .content-wrapper {
      filter: none;
      transition: filter 0.5s ease-in-out;
    }
    
    /* Auth modal - make sure it's on top and fully visible */
    #authModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      background: rgba(0, 0, 0, 0.7);
    }
    
    .auth-container {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      margin: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 2001;
    }

    /* Improved button styles for better click handling */
    .google-btn, .email-submit {
      position: relative;
      overflow: hidden;
    }

    .google-btn::after, .email-submit::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 1;
    }
    
    /* Loading states for buttons */
    .is-loading .btn-text {
      opacity: 0;
    }
    
    .is-loading .spinner {
      display: inline-block;
    }
    
    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Improved toast notifications */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
    }
    
    .toast {
      padding: 12px 16px;
      background: white;
      color: #333;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      min-width: 300px;
      max-width: 450px;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      border-left: 4px solid #10B981;
    }
    
    .toast.error {
      border-left: 4px solid #EF4444;
    }
    
    .toast-icon {
      margin-right: 12px;
      font-size: 18px;
    }
    
    .toast.success .toast-icon {
      color: #10B981;
    }
    
    .toast.error .toast-icon {
      color: #EF4444;
    }
  </style>
</head>

<body class="unauthenticated">
  <!-- Toast container -->
  <div id="toast-container"></div>
  
  <!-- Content wrapper that will be blurred before auth -->
  <div class="content-wrapper">
    <!-- All your existing content goes here -->
    <!-- Navigation bar -->
    <div class="navbar">
      <!-- Existing navbar content -->
    </div>
    
    <!-- Main content -->
    <div class="content">
      <!-- Existing content -->
    </div>
  </div>
  
  <!-- Auth Modal - outside the content wrapper so it's not blurred -->
  <div id="authModal">
    <div class="auth-container">
      <h2 class="text-2xl font-bold text-center mb-2">Real Conversations.</h2>
      <h2 class="text-2xl font-bold text-center mb-4">Real Confidence.</h2>
      <p class="text-gray-600 text-center mb-6">Please sign in to continue.</p>
      
      <!-- Email Sign In -->
      <form id="email-form" class="space-y-4">
        <input type="email" id="email" placeholder="Enter your email" required
               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
        
        <button type="submit" class="email-submit w-full py-3 px-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-lg relative">
          <span class="btn-text">Send Magic Link</span>
          <div class="spinner"></div>
        </button>
      </form>
      
      <div id="auth-status-message" class="mt-4 text-sm text-center"></div>
      
      <p class="mt-6 text-xs text-center text-gray-500">
        By continuing, you agree to our 
        <a href="/terms" class="text-purple-600 hover:underline">Terms</a> & 
        <a href="/privacy" class="text-purple-600 hover:underline">Privacy</a>
      </p>
    </div>
  </div>

  <!-- Authentication Scripts -->
  <script type="module">
    import { UserService, AuthService } from './js/services.js';
    import { USER_ROLES, PROMPT_LIMITS, ANALYTICS_EVENTS, REFERRAL_SYSTEM } from './js/config.js';

    // Constants from config
    const FREE_PROMPT_LIMIT = PROMPT_LIMITS.FREE.total;
    const MAX_REFERRALS_REWARDED = 3;
    const REFERRAL_PROMPTS_TIERS = REFERRAL_SYSTEM.rewards;

    // Local Storage Keys
    const LS_KEY_PROMPTS = 'izzy_prompts_left';
    const LS_KEY_CHAT = 'izzy_chat_history';
    const LS_KEY_REFERRER = 'izzy_referrer';
    const LS_KEY_REFERRAL_VISITED_PREFIX = 'izzy_referral_visited_';

    // Application state
    const state = {
        currentUser: null,
        currentUserId: null,
        promptsUsed: 0,
        promptsLeft: FREE_PROMPT_LIMIT,
        isSubscribed: false,
        currentConversationId: null,
        personalReferralLink: "",
        successfulReferralCount: 0,
        recaptchaVerifier: null,
        domElements: {}
    };

    // Initialize Firebase Auth state listener
    const auth = firebase.auth();
    auth.onAuthStateChanged(user => {
        if (user) {
            // User is signed in
            const isNewUser = user.metadata.creationTime === user.metadata.lastSignInTime;
            state.currentUser = user;
            state.currentUserId = user.uid;
            console.log("User signed in:", state.currentUserId, "Is new user:", isNewUser);

            // Generate personal referral link
            state.personalReferralLink = `${window.location.origin}${window.location.pathname}?ref=${state.currentUserId}`;
            if(state.domElements.personalLinkInput) {
                state.domElements.personalLinkInput.value = state.personalReferralLink;
            }

            updateAuthUI(true);
            state.domElements.authModal?.classList.add('hidden');
            state.domElements.mainContent?.classList.remove('blur-background');
            loadUserData(state.currentUserId);

            if (isNewUser) {
                creditReferrerOnSignUp(state.currentUserId);
            }
        } else {
            // User is signed out
            console.log("User signed out.");
            state.currentUser = null;
            state.currentUserId = null;
            state.personalReferralLink = "";
            state.successfulReferralCount = 0;

            updateAuthUI(false);
            resetAppState();
            updateShareSectionUI();
            openAuthModal();
        }

        // Force auth modal visible until Firebase finishes auth check
        if (!firebase.auth().currentUser) openAuthModal();
    });

    /* ---------------- DOM Element References ---------------- */
    function cacheDomElements() {
        Object.assign(state.domElements, {
            authModal: document.getElementById('authModal'),
            subscribeModal: document.getElementById('subscribeModal'),
            shareModal: document.getElementById('shareModal'),
            mainContent: document.getElementById('mainContent'),
            authStatusMessage: document.getElementById('auth-status-message'),
            logoutButton: document.getElementById('logoutButton'),
            mobileLogoutButton: document.getElementById('mobile-logoutButton'),
            recaptchaContainer: document.getElementById('recaptcha-container'),
            emailForm: document.getElementById('email-form'),
            emailInput: document.getElementById('email'),
            emailSubmitBtn: document.getElementById('email-submit-btn'),
            googleSigninBtn: document.getElementById('google-signin-btn'),
            chatContainer: document.getElementById('chat-container'),
            conversationHistorySection: document.getElementById('conversation-history'),
            promptsWarning: document.getElementById('prompts-warning'),
            promptsWarningCount: document.getElementById('prompts-warning-count'),
            userInput: document.getElementById('userInput'),
            sendButton: document.getElementById('sendButton'),
            sendButtonText: document.querySelector('#sendButton .send-btn-text'),
            sendButtonSpinner: document.querySelector('#sendButton .spinner'),
            emailButtonText: document.querySelector('#email-submit-btn .email-btn-text'),
            emailButtonSpinner: document.querySelector('#email-submit-btn .spinner'),
            restartBtn: document.getElementById('restartBtn'),
            toast: document.getElementById('toast'),
            mobileMenuButton: document.getElementById('mobile-menu-button'),
            mobileMenu: document.getElementById('mobile-menu'),
            closeMobileMenuButton: document.getElementById('close-mobile-menu'),
            mobileMenuLinks: document.querySelectorAll('.mobile-menu-link'),
            conversationCountEl: document.getElementById('conversation-count'),
            skillLevelEl: document.getElementById('skill-level'),
            promptsLeftEl: document.getElementById('prompts-left'),
            avatarFrame: document.getElementById('avatarFrame'),
            micButtonIcon: document.querySelector('#micButton i'),
            personalLinkInput: document.getElementById('personalLink'),
            rewardsTextEl: document.getElementById('rewardsText'),
            referralStatusEl: document.getElementById('referralStatus'),
            shareTierButtons: {
                1: document.getElementById('btnTier1'),
                2: document.getElementById('btnTier2'),
                3: document.getElementById('btnTier3')
            }
        });
    }

    // ... rest of your existing code ...
  </script>

  <!-- The rest of your scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script>
  /* ---------------- Firebase Initialization ---------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBlmM-6P2WHj59R5FAvFy6ZjIDA637f7p4",
    authDomain: "izzy-auth.firebaseapp.com",
    databaseURL: "https://izzy-auth-default-rtdb.firebaseio.com",
    projectId: "izzy-auth",
    storageBucket: "izzy-auth.appspot.com",
    messagingSenderId: "573135779043",
    appId: "1:573135779043:web:f6c59473f9956c917041d6",
    measurementId: "G-8JLKB2MMKS"
  };

  // Initialize Firebase with error handling
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();
    console.log("Firebase initialized successfully");
  } catch (error) {
    console.error("Error initializing Firebase:", error);
    showToast("Error initializing app. Please refresh the page.", true);
  }

  // Magic Link Sign-in Function with improved validation and debugging
  function sendMagicLink(event) {
    event.preventDefault();
    console.log("Starting magic link process...");
    
    const email = document.getElementById('email')?.value?.trim();
    
    if (!email || !email.includes('@')) {
        showToast("Please enter a valid email address.", true);
        return;
    }

    const actionCodeSettings = {
        url: window.location.origin + window.location.pathname, // Use full current URL
        handleCodeInApp: true
    };

    console.log("Sending magic link to:", email);
    console.log("Action code settings:", actionCodeSettings);

    const submitBtn = document.querySelector('.email-submit');
    const btnText = submitBtn?.querySelector('.btn-text');
    const spinner = submitBtn?.querySelector('.spinner');

    // Show loading state
    if (submitBtn) submitBtn.disabled = true;
    if (btnText) btnText.style.opacity = '0';
    if (spinner) spinner.style.display = 'block';

    showToast("Sending magic link...", false);

    // Store email for later
    localStorage.setItem('emailForSignIn', email);

    firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
        .then(() => {
            console.log("Magic link sent successfully");
            showToast(`Magic link sent to ${email}! Check your inbox (and spam folder).`, false);
            if (document.getElementById('email')) {
                document.getElementById('email').value = '';
            }
        })
        .catch((error) => {
            console.error("Error sending magic link:", error);
            let errorMessage = "Error sending sign-in link. ";
            
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage += "Please enter a valid email address.";
                    break;
                case 'auth/operation-not-allowed':
                    errorMessage += "Email/password accounts are not enabled. Please contact support.";
                    break;
                default:
                    errorMessage += error.message;
            }
            
            showToast(errorMessage, true);
        })
        .finally(() => {
            // Reset button state
            if (submitBtn) submitBtn.disabled = false;
            if (btnText) btnText.style.opacity = '1';
            if (spinner) spinner.style.display = 'none';
        });
}

// Handle Magic Link Sign-in with improved error handling
function handleMagicLinkSignIn() {
    console.log("Checking for sign-in link...");
    console.log("Current URL:", window.location.href);
    
    if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
        console.log("Valid sign-in link detected");
        
        let email = localStorage.getItem('emailForSignIn');
        if (!email) {
            email = window.prompt('Please provide your email for confirmation');
        }

        if (email) {
            console.log("Attempting to sign in with email:", email);
            showToast("Signing you in...", false);
            
            firebase.auth().signInWithEmailLink(email, window.location.href)
                .then((result) => {
                    console.log("Sign-in successful");
                    localStorage.removeItem('emailForSignIn');
                    showToast('Successfully signed in!', false);
                    
                    // Remove the sign-in link from the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Hide auth modal after successful sign-in
                    const authModal = document.getElementById('authModal');
                    if (authModal) {
                        authModal.style.display = 'none';
                    }

                    // Initialize new user if needed
                    if (result.additionalUserInfo?.isNewUser) {
                        return initializeNewUser(result.user);
                    }
                })
                .catch((error) => {
                    console.error('Error signing in with email link:', error);
                    showToast(error.message || 'Error signing in. Please try again.', true);
                });
        }
    } else {
        console.log("No valid sign-in link detected in URL");
    }
}

  // ... rest of your existing code ...
  </script>

</body>
</html>
