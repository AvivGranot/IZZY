<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IZZY – AI Avatar for Real Conversations</title>

  <meta name="description" content="Practice real conversations with IZZY, the AI avatar coach.">
  <meta property="og:image" content="/img/og.png">
  <meta property="og:title" content="IZZY – AI Avatar for Real Conversations">
  <meta property="og:description" content="Practice real conversations with IZZY, the AI avatar coach.">
  <meta property="og:url" content="https://your‑domain.com">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://your‑domain.com/img/og.png">
  <meta property="og:image:alt" content="Screenshot of IZZY AI avatar app">

  <!-- Tailwind Configuration -->
  <script>
    // Extend Tailwind theme with custom colors
    window.tailwindConfig = {
      theme: {
        extend: {
          colors: {
            'izzy-blue': '#0047AB',
            'izzy-purple': {
              500: '#8B5CF6',
              600: '#7C3AED',
              700: '#6D28D9'
            },
            'izzy-pink': {
              500: '#EC4899',
              600: '#DB2777'
            }
          },
        }
      },
    }
  </script>

  <!-- External Resources -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <script>
    // Initialize Tailwind with our config after it loads
    document.addEventListener('DOMContentLoaded', () => {
      if (window.tailwind) {
        window.tailwind.config = window.tailwindConfig;
      }
    });

    // Add resource load error handling
    function handleResourceError(e) {
      console.error('Failed to load resource:', e.target.src || e.target.href);
      const element = document.createElement('div');
      element.style.position = 'fixed';
      element.style.top = '0';
      element.style.left = '0';
      element.style.right = '0';
      element.style.backgroundColor = '#ef4444';
      element.style.color = 'white';
      element.style.padding = '1rem';
      element.style.textAlign = 'center';
      element.style.zIndex = '9999';
      element.textContent = 'Failed to load some resources. Please refresh the page.';
      document.body.prepend(element);
    }

    // Add error handlers to all external resources
    window.addEventListener('load', () => {
      document.querySelectorAll('link[rel="stylesheet"], script[src]').forEach(el => {
        el.addEventListener('error', handleResourceError);
      });
    });
  </script>

  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #fff;
      color: #333;
      line-height: 1.5;
    }

    /* Remove ALL blur effects */
    .glass {
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    /* Clear background blur */
    .blur-background {
      filter: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    /* Hero section styles */
    .hero {
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: #fff;
      padding: 2rem;
    }

    .hero h1 {
      font-size: 4rem;
      font-weight: 700;
      color: #000;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-rendering: optimizeLegibility;
    }

    .hero h2 {
      font-size: 2rem;
      color: #666;
      margin-bottom: 2rem;
      text-rendering: optimizeLegibility;
    }

    /* Auth modal styles */
    #authModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.5);
    }

    .auth-container {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      margin: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .auth-logo {
      width: auto;
      height: 32px;
      margin: 0 auto 1.5rem;
      display: block;
    }

    .auth-title {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.5rem;
      color: #1a1a1a;
    }

    .auth-subtitle {
      font-size: 16px;
      color: #666;
      text-align: center;
      margin-bottom: 2rem;
    }

    .google-btn {
      width: 100%;
      padding: 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      color: #1a1a1a;
      cursor: pointer;
      transition: all 0.2s;
    }

    .google-btn:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }

    .google-btn img {
      width: 20px;
      height: 20px;
    }

    .divider {
      position: relative;
      text-align: center;
      margin: 1.5rem 0;
    }

    .divider::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #e2e8f0;
    }

    .divider span {
      background: white;
      padding: 0 1rem;
      color: #666;
      position: relative;
    }

    .email-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 16px;
    }

    .email-input:focus {
      outline: none;
      border-color: #8B5CF6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .email-submit {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #8B5CF6, #EC4899);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .email-submit:hover {
      opacity: 0.95;
    }

    .email-submit:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .spinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .spinner.visible {
      display: block;
    }

    .terms {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-top: 1.5rem;
    }

    .terms a {
      color: #8B5CF6;
      text-decoration: none;
    }

    .terms a:hover {
      text-decoration: underline;
    }

    /* Input styles */
    .input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }

    /* Remove any backdrop filters */
    .glass {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    /* Basic Reset & Font */
    * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background: #fff; color:#333; }

    /* Clear any backdrop filters that might cause blur */
    .glass {
      background: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      border: 1px solid rgba(139, 92, 246, 0.1);
    }

    /* Ensure text is sharp */
    .auth-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #333;
      text-rendering: optimizeLegibility;
    }

    .auth-subtitle {
      font-size: 1.1rem;
      color: #666;
      margin-bottom: 2rem;
      text-rendering: optimizeLegibility;
    }

    /* Button styles */
    .google-btn {
      background: white;
      color: #333;
      border: 1px solid #ddd;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-bottom: 1rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .google-btn:hover {
      background: #f8f8f8;
      border-color: #ccc;
    }

    .email-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .email-submit {
      background: linear-gradient(to right, #8B5CF6, #EC4899);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      width: 100%;
      font-weight: 500;
      transition: all 0.2s;
    }

    .email-submit:hover {
      opacity: 0.9;
    }

    /* Backdrop-blur card effect */
    .glass {
      background: rgba(255,255,255,0.85); /* Semi-transparent white */
      backdrop-filter: blur(10px); /* Blur effect */
      -webkit-backdrop-filter: blur(10px); /* Safari support */
      border-radius: 1rem; /* Rounded corners */
      padding: 2rem; /* Padding */
      box-shadow: 0 20px 25px rgba(0,0,0,0.05); /* Subtle shadow */
      border: 1px solid rgba(255, 255, 255, 0.2); /* Optional subtle border */
    }

    /* Blur background behind modals */
    .blur-background { filter: blur(8px); pointer-events:none; }

    /* Simple fade-in animation */
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:none;} }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }

    /* Hidden helper class */
    .visually-hidden { display:none; }

    /* Chat bubble styling */
    .chat-bubble {
      border-radius: 18px; /* Rounded bubbles */
      padding: 10px 15px; /* Padding inside bubbles */
      max-width: 80%; /* Max width to prevent full width */
      margin-bottom: 10px; /* Spacing between bubbles */
      word-wrap: break-word; /* Ensure long words break */
    }
    .user-bubble {
      background-color: #E9F3FF; /* Light blue for user */
      margin-left: auto; /* Align to the right */
      border-bottom-right-radius: 4px; /* Slightly less round corner */
    }
    .assistant-bubble {
      background-color: #F2F2F7; /* Light gray for assistant */
      margin-right: auto; /* Align to the left */
      border-bottom-left-radius: 4px; /* Slightly less round corner */
    }

    /* Focus states for better accessibility */
    button:focus, input:focus, a:focus, iframe:focus, textarea:focus { /* Added textarea */
      outline: 2px solid #8B5CF6; /* Purple outline */
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3); /* Optional softer glow */
    }
    /* Remove default iframe border if focused */
    iframe:focus {
        border: none;
    }


    /* Loading spinner animation */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3); /* Light border */
      border-radius: 50%; /* Circle */
      border-top: 3px solid #8B5CF6; /* Purple top border for spin effect */
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile responsiveness for Navigation */
    @media (max-width: 640px) {
      .mobile-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 100; /* Ensure it's above other content */
        padding: 2rem;
        transform: translateX(-100%); /* Start off-screen */
        transition: transform 0.3s ease;
        display: flex; /* Use flex for layout */
        flex-direction: column; /* Stack items vertically */
      }

      .mobile-menu.open {
        transform: translateX(0); /* Slide in */
      }

      .desktop-nav {
        display: none; /* Hide desktop nav on small screens */
      }

      .mobile-nav-button {
        display: block; /* Show mobile button */
      }
    }

    @media (min-width: 641px) {
      .mobile-nav-button {
        display: none; /* Hide mobile button on large screens */
      }

      .mobile-menu {
        display: none; /* Hide mobile menu */
      }

      .desktop-nav {
        display: flex; /* Show desktop nav */
      }
    }

    /* Styles from subscribe.html */
    .plan-card {
      transition: all 0.3s ease;
    }
    .plan-card:hover {
      transform: translateY(-8px);
    }
    .popular-badge {
      position: absolute;
      top: -12px;
      right: 20px;
      background: linear-gradient(to right, #9333ea, #ec4899);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .gradient-border {
      position: relative;
      border-radius: 1rem;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(to right, #9333ea, #ec4899) border-box;
      border: 2px solid transparent;
    }

    /* Styles from share.html */
    .share-button{transition:all .3s ease}
    .share-button:hover{transform:translateY(-3px)}
    .gradient-card{background:linear-gradient(white,white) padding-box,
                    linear-gradient(to right,#9333ea,#ec4899) border-box;border:2px solid transparent;border-radius:1rem}
    .gradient-bg{background:linear-gradient(135deg,rgba(147,51,234,.08),rgba(236,72,153,.08))}
    .disabled{opacity:.5;cursor:not-allowed !important;transform:none !important}

    .main-content {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      filter: blur(10px);
      transition: filter 0.3s ease;
    }

    .main-content.authenticated {
      filter: none;
    }

    /* Add this at the beginning of your styles */
    body.pre-auth::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('assets/bg.jpg') center/cover no-repeat;
        filter: blur(8px);
        z-index: -1;
    }

    body.pre-auth .content-container {
        filter: blur(8px);
    }
    
    body.auth-complete .content-container {
        filter: none;
        transition: filter 0.5s ease;
    }
    
    /* Auth modal styling */
    #authModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
    }
    
    .auth-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        margin: 1rem;
    }
    
    .auth-logo {
        display: block;
        width: auto;
        height: 40px;
        margin: 0 auto 1.5rem;
    }
    
    .auth-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-align: center;
        color: #1a1a1a;
    }
    
    .auth-subtitle {
        color: #666;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .google-btn {
        width: 100%;
        padding: 0.75rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1.5rem;
    }
    
    .google-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    
    .divider {
        position: relative;
        text-align: center;
        margin: 1.5rem 0;
    }
    
    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e2e8f0;
    }
    
    .divider span {
        position: relative;
        background: white;
        padding: 0 1rem;
        color: #666;
    }
    
    .auth-form {
        margin-bottom: 1.5rem;
    }
    
    .auth-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .auth-input:focus {
        outline: none;
        border-color: #8B5CF6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .auth-button {
        width: 100%;
        padding: 0.75rem;
        background: linear-gradient(135deg, #8B5CF6, #EC4899);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        position: relative;
    }
    
    .auth-button:hover {
        opacity: 0.95;
    }
    
    .auth-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .auth-button .spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: spin 1s linear infinite;
    }
    
    .auth-button .btn-text {
        transition: opacity 0.2s;
    }
    
    .auth-button.loading .btn-text {
        opacity: 0;
    }
    
    .auth-button.loading .spinner {
        display: block;
    }
    
    .auth-status {
        margin-top: 1rem;
        text-align: center;
        font-size: 0.875rem;
    }
    
    .auth-terms {
        text-align: center;
        font-size: 12px;
        color: #666;
        margin-top: 1.5rem;
    }
    
    .auth-terms a {
        color: #8B5CF6;
        text-decoration: none;
    }
    
    .auth-terms a:hover {
        text-decoration: underline;
    }
    
    @keyframes spin {
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Toast notification */
    .toast {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 1rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 300px;
        z-index: 1001;
        transition: transform 0.3s, opacity 0.3s;
        transform: translateY(-10px);
        opacity: 0;
    }
    
    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    
    .toast.success {
        border-left: 4px solid #10B981;
    }
    
    .toast.error {
        border-left: 4px solid #EF4444;
    }

    /* Add these styles at the top of your existing style block */
    
    /* Blurry background before authentication */
    body.unauthenticated .content-wrapper {
      filter: blur(8px);
      transition: filter 0.5s ease-in-out;
    }
    
    body.authenticated .content-wrapper {
      filter: none;
      transition: filter 0.5s ease-in-out;
    }
    
    /* Auth modal - make sure it's on top and fully visible */
    #authModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      background: rgba(0, 0, 0, 0.7);
    }
    
    .auth-container {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      margin: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 2001;
    }

    /* Improved button styles for better click handling */
    .google-btn, .email-submit {
      position: relative;
      overflow: hidden;
    }

    .google-btn::after, .email-submit::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 1;
    }
    
    /* Loading states for buttons */
    .is-loading .btn-text {
      opacity: 0;
    }
    
    .is-loading .spinner {
      display: inline-block;
    }
    
    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Improved toast notifications */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
    }
    
    .toast {
      padding: 12px 16px;
      background: white;
      color: #333;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      min-width: 300px;
      max-width: 450px;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      border-left: 4px solid #10B981;
    }
    
    .toast.error {
      border-left: 4px solid #EF4444;
    }
    
    .toast-icon {
      margin-right: 12px;
      font-size: 18px;
    }
    
    .toast.success .toast-icon {
      color: #10B981;
    }
    
    .toast.error .toast-icon {
      color: #EF4444;
    }
  </style>
</head>

<body class="unauthenticated">
  <!-- Toast container -->
  <div id="toast-container"></div>
  
  <!-- Content wrapper that will be blurred before auth -->
  <div class="content-wrapper">
    <!-- All your existing content goes here -->
    <!-- Navigation bar -->
    <div class="navbar">
      <!-- Existing navbar content -->
    </div>
    
    <!-- Main content -->
    <div class="content">
      <!-- Existing content -->
    </div>
  </div>
  
  <!-- Auth Modal - outside the content wrapper so it's not blurred -->
  <div id="authModal">
    <div class="auth-container">
      <img src="assets/izzy-logo.png" alt="IZZY" class="mx-auto h-10 mb-6">
      <h2 class="text-2xl font-bold text-center mb-2">Real Conversations.</h2>
      <h2 class="text-2xl font-bold text-center mb-4">Real Confidence.</h2>
      <p class="text-gray-600 text-center mb-6">Please log in or sign up to continue.</p>
      
      <!-- Google Sign In -->
      <button id="google-signin-btn" class="google-btn w-full flex items-center justify-center gap-3 py-3 px-4 bg-white border border-gray-300 rounded-lg text-gray-800 font-medium mb-4 relative">
        <img src="assets/google.svg" alt="Google" class="w-5 h-5">
        <span class="btn-text">Continue with Google</span>
        <div class="spinner"></div>
      </button>
      
      <div class="relative my-6">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-3 bg-white text-gray-500">OR</span>
        </div>
      </div>
      
      <!-- Email Sign In -->
      <form id="email-form" class="space-y-4">
        <input type="email" id="email" placeholder="Enter your email" required
               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
        
        <button type="submit" class="email-submit w-full py-3 px-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-lg relative">
          <span class="btn-text">Send Magic Link</span>
          <div class="spinner"></div>
        </button>
      </form>
      
      <div id="auth-status-message" class="mt-4 text-sm text-center"></div>
      
      <p class="mt-6 text-xs text-center text-gray-500">
        By continuing, you agree to our 
        <a href="/terms" class="text-purple-600 hover:underline">Terms</a> & 
        <a href="/privacy" class="text-purple-600 hover:underline">Privacy</a>
      </p>
    </div>
  </div>

  <!-- Authentication Scripts -->
  <script>
    // Use the existing Firebase configuration
    // Don't redeclare firebaseConfig
    
    // Toast notification system
    function showToast(message, isError = false) {
      const toastContainer = document.getElementById('toast-container');
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${isError ? 'error' : 'success'}`;
      
      const icon = document.createElement('span');
      icon.className = 'toast-icon';
      icon.innerHTML = isError ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>';
      
      const text = document.createElement('span');
      text.textContent = message;
      
      toast.appendChild(icon);
      toast.appendChild(text);
      toastContainer.appendChild(toast);
      
      // Trigger reflow for animation
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // Auto remove after 4 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 4000);
    }
    
    // Google Sign In
    function signInWithGoogle() {
      console.log('Starting Google sign-in');
      
      const button = document.getElementById('google-signin-btn');
      const btnText = button.querySelector('.btn-text');
      const spinner = button.querySelector('.spinner');
      const statusMsg = document.getElementById('auth-status-message');
      
      // Disable button and show loading state
      button.disabled = true;
      button.classList.add('is-loading');
      btnText.style.opacity = '0';
      spinner.style.display = 'block';
      
      if (statusMsg) {
        statusMsg.textContent = 'Connecting to Google...';
        statusMsg.className = 'mt-4 text-sm text-purple-600';
      }
      
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      
      firebase.auth().signInWithPopup(provider)
        .then((result) => {
          console.log('Google sign-in successful');
          
          // If new user, initialize their data
          if (result.additionalUserInfo?.isNewUser) {
            return initializeNewUser(result.user);
          }
          
          showToast('Successfully signed in!', false);
          
          // Update UI for authenticated state
          document.body.classList.remove('unauthenticated');
          document.body.classList.add('authenticated');
          
          // Hide auth modal
          const authModal = document.getElementById('authModal');
          if (authModal) authModal.style.display = 'none';
        })
        .catch((error) => {
          console.error('Google sign-in error:', error);
          
          let errorMessage = 'Sign-in failed. Please try again.';
          
          switch (error.code) {
            case 'auth/popup-blocked':
              errorMessage = 'Pop-up was blocked. Please allow pop-ups for this site.';
              break;
            case 'auth/popup-closed-by-user':
              errorMessage = 'Sign-in was cancelled. Please try again.';
              break;
            case 'auth/auth-domain-config-required':
              errorMessage = 'Authentication configuration error. Please try again.';
              break;
            default:
              errorMessage = error.message || 'An error occurred during sign-in.';
          }
          
          showToast(errorMessage, true);
          
          if (statusMsg) {
            statusMsg.textContent = errorMessage;
            statusMsg.className = 'mt-4 text-sm text-red-600';
          }
        })
        .finally(() => {
          // Reset button state
          button.disabled = false;
          button.classList.remove('is-loading');
          btnText.style.opacity = '1';
          spinner.style.display = 'none';
        });
    }
    
    // Email Magic Link
    function sendMagicLink(event) {
      event.preventDefault();
      
      const email = document.getElementById('email')?.value?.trim();
      const button = document.querySelector('.email-submit');
      const btnText = button.querySelector('.btn-text');
      const spinner = button.querySelector('.spinner');
      const statusMsg = document.getElementById('auth-status-message');
      
      if (!email) {
        showToast('Please enter your email address', true);
        if (statusMsg) {
          statusMsg.textContent = 'Please enter your email address';
          statusMsg.className = 'mt-4 text-sm text-red-600';
        }
        return;
      }
      
      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('Please enter a valid email address', true);
        if (statusMsg) {
          statusMsg.textContent = 'Please enter a valid email address';
          statusMsg.className = 'mt-4 text-sm text-red-600';
        }
        return;
      }
      
      // Disable button and show loading state
      button.disabled = true;
      button.classList.add('is-loading');
      btnText.style.opacity = '0';
      spinner.style.display = 'block';
      
      if (statusMsg) {
        statusMsg.textContent = 'Sending magic link...';
        statusMsg.className = 'mt-4 text-sm text-purple-600';
      }
      
      // Store email for later (after redirect)
      localStorage.setItem('emailForSignIn', email);
      
      const actionCodeSettings = {
        url: window.location.href,
        handleCodeInApp: true
      };
      
      firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
        .then(() => {
          console.log('Magic link sent successfully');
          showToast(`Magic link sent to ${email}! Check your inbox.`, false);
          document.getElementById('email').value = '';
          
          if (statusMsg) {
            statusMsg.textContent = 'Check your email for the magic link!';
            statusMsg.className = 'mt-4 text-sm text-green-600';
          }
        })
        .catch((error) => {
          console.error('Error sending magic link:', error);
          
          let errorMessage = 'Failed to send magic link. Please try again.';
          
          if (error.code === 'auth/invalid-email') {
            errorMessage = 'Please enter a valid email address';
          } else if (error.code === 'auth/missing-android-pkg-name') {
            errorMessage = 'Authentication configuration error. Please try again later.';
          }
          
          showToast(errorMessage, true);
          
          if (statusMsg) {
            statusMsg.textContent = errorMessage;
            statusMsg.className = 'mt-4 text-sm text-red-600';
          }
        })
        .finally(() => {
          // Reset button state
          button.disabled = false;
          button.classList.remove('is-loading');
          btnText.style.opacity = '1';
          spinner.style.display = 'none';
        });
    }
    
    // Handle Magic Link Sign-in
    function handleMagicLinkSignIn() {
      if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
        console.log('Magic link detected in URL');
        
        let email = localStorage.getItem('emailForSignIn');
        
        if (!email) {
          email = window.prompt('Please provide your email for confirmation');
        }
        
        if (email) {
          const statusMsg = document.getElementById('auth-status-message');
          if (statusMsg) {
            statusMsg.textContent = 'Signing you in...';
            statusMsg.className = 'mt-4 text-sm text-purple-600';
          }
          
          firebase.auth().signInWithEmailLink(email, window.location.href)
            .then((result) => {
              console.log('Successfully signed in with email link');
              localStorage.removeItem('emailForSignIn');
              
              // If new user, initialize their data
              if (result.additionalUserInfo?.isNewUser) {
                return initializeNewUser(result.user);
              }
              
              showToast('Successfully signed in!', false);
              
              // Update UI for authenticated state
              document.body.classList.remove('unauthenticated');
              document.body.classList.add('authenticated');
              
              // Hide auth modal
              const authModal = document.getElementById('authModal');
              if (authModal) authModal.style.display = 'none';
            })
            .catch((error) => {
              console.error('Error signing in with email link:', error);
              showToast('Error signing in. Please try again.', true);
              
              if (statusMsg) {
                statusMsg.textContent = 'Error signing in. Please try again.';
                statusMsg.className = 'mt-4 text-sm text-red-600';
              }
            });
        }
      }
    }
    
    // Initialize Authentication State
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Firebase if not already done
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      
      // Check if Firebase is initialized properly
      console.log('Firebase initialized:', firebase.apps.length > 0);
      
      // Add event listeners for auth forms
      const emailForm = document.getElementById('email-form');
      if (emailForm) {
        emailForm.addEventListener('submit', sendMagicLink);
      }
      
      const googleBtn = document.getElementById('google-signin-btn');
      if (googleBtn) {
        googleBtn.addEventListener('click', signInWithGoogle);
      }
      
      // Handle magic link authentication
      handleMagicLinkSignIn();
      
      // Listen for auth state changes
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          console.log('User is signed in:', user.email);
          document.body.classList.remove('unauthenticated');
          document.body.classList.add('authenticated');
          
          // Hide auth modal
          const authModal = document.getElementById('authModal');
          if (authModal) authModal.style.display = 'none';
        } else {
          console.log('No user is signed in');
          document.body.classList.add('unauthenticated');
          document.body.classList.remove('authenticated');
        }
      });
    });
    
    // Initialize new user data in the database
    function initializeNewUser(user) {
      if (!user) return Promise.reject('No user provided');
      
      const userData = {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName || '',
        photoURL: user.photoURL || '',
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        promptsLeft: 3,
        isSubscribed: false,
        referralCode: generateReferralCode(),
        referralsCount: 0
      };
      
      return firebase.database().ref(`users/${user.uid}`).set(userData)
        .then(() => {
          console.log('New user data initialized successfully');
          return userData;
        })
        .catch(error => {
          console.error('Error initializing user data:', error);
          throw error;
        });
    }
    
    // Generate a random referral code
    function generateReferralCode() {
      return Math.random().toString(36).substring(2, 10).toUpperCase();
    }
  </script>

  <!-- The rest of your scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script>
  /* ---------------- Firebase Initialization ---------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBlmM-6P2WHj59R5FAvFy6ZjIDA637f7p4",
    authDomain: "izzy-auth.firebaseapp.com",
    databaseURL: "https://izzy-auth-default-rtdb.firebaseio.com",
    projectId: "izzy-auth",
    storageBucket: "izzy-auth.appspot.com",
    messagingSenderId: "573135779043",
    appId: "1:573135779043:web:f6c59473f9956c917041d6",
    measurementId: "G-8JLKB2MMKS"
  };

  // Initialize Firebase with error handling
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();
    console.log("Firebase initialized successfully");
  } catch (error) {
    console.error("Error initializing Firebase:", error);
    showToast("Error initializing app. Please refresh the page.", true);
  }

  // Google Sign-in Function with improved error handling
  function signInWithGoogle() {
    console.log("Starting Google sign-in process");
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    
    const googleBtn = document.getElementById('google-signin-btn');
    const statusMessage = document.getElementById('auth-status-message');
    
    if (googleBtn) {
      googleBtn.disabled = true;
      googleBtn.classList.add('opacity-75');
    }
    
    if (statusMessage) {
      statusMessage.textContent = "Connecting to Google...";
      statusMessage.className = "mt-4 text-sm text-purple-600";
    }

    firebase.auth().signInWithPopup(provider)
      .then((result) => {
        console.log("Google sign-in successful");
        showToast("Successfully signed in with Google!", false);
        if (result.additionalUserInfo?.isNewUser) {
          return initializeNewUser(result.user);
        }
      })
      .catch((error) => {
        console.error("Google sign-in error:", error);
        let errorMessage = "Google sign-in failed. Please try again.";
        
        switch (error.code) {
          case 'auth/popup-blocked':
            errorMessage = "Sign-in popup was blocked. Please allow popups and try again.";
            break;
          case 'auth/popup-closed-by-user':
            errorMessage = "Sign-in was cancelled. Please try again.";
            break;
          case 'auth/auth-domain-config-required':
            errorMessage = "Please try again in a few moments.";
            break;
          default:
            errorMessage = error.message;
        }
        
        showToast(errorMessage, true);
        if (statusMessage) {
          statusMessage.textContent = errorMessage;
          statusMessage.className = "mt-4 text-sm text-red-600";
        }
      })
      .finally(() => {
        if (googleBtn) {
          googleBtn.disabled = false;
          googleBtn.classList.remove('opacity-75');
        }
      });
  }

  // Magic Link Sign-in Function with improved validation
  function sendMagicLink(event) {
    event.preventDefault();
    console.log("Starting magic link process");
    
    const emailInput = document.getElementById('email');
    const email = emailInput?.value?.trim();
    const statusMessage = document.getElementById('auth-status-message');
    
    if (!email) {
      showToast("Please enter your email address.", true);
      if (statusMessage) {
        statusMessage.textContent = "Please enter your email address.";
        statusMessage.className = "mt-4 text-sm text-red-600";
      }
      return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showToast("Please enter a valid email address.", true);
      if (statusMessage) {
        statusMessage.textContent = "Please enter a valid email address.";
        statusMessage.className = "mt-4 text-sm text-red-600";
      }
      return;
    }
    
    const submitBtn = document.querySelector('.email-submit');
    const btnText = submitBtn?.querySelector('.email-btn-text');
    const spinner = submitBtn?.querySelector('.spinner');
    
    if (submitBtn) {
      submitBtn.disabled = true;
    }
    if (btnText) {
      btnText.classList.add('hidden');
    }
    if (spinner) {
      spinner.classList.remove('hidden');
    }
    
    if (statusMessage) {
      statusMessage.textContent = "Sending magic link...";
      statusMessage.className = "mt-4 text-sm text-purple-600";
    }
    
    // Store email for later
    localStorage.setItem('emailForSignIn', email);
    
    const actionCodeSettings = {
      url: window.location.href,
      handleCodeInApp: true
    };
    
    firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
      .then(() => {
        console.log("Magic link sent successfully");
        showToast(`Magic link sent to ${email}! Check your inbox.`, false);
        if (emailInput) emailInput.value = '';
        if (statusMessage) {
          statusMessage.textContent = "Check your email for the magic link!";
          statusMessage.className = "mt-4 text-sm text-green-600";
        }
      })
      .catch((error) => {
        console.error("Error sending magic link:", error);
        let errorMessage = "Error sending sign-in link. Please try again.";
        if (error.code === 'auth/invalid-email') {
          errorMessage = "Please enter a valid email address.";
        }
        showToast(errorMessage, true);
        if (statusMessage) {
          statusMessage.textContent = errorMessage;
          statusMessage.className = "mt-4 text-sm text-red-600";
        }
      })
      .finally(() => {
        if (submitBtn) {
          submitBtn.disabled = false;
        }
        if (btnText) {
          btnText.classList.remove('hidden');
        }
        if (spinner) {
          spinner.classList.add('hidden');
        }
      });
  }

  // Handle Magic Link Sign-in
  function handleMagicLinkSignIn() {
    if (auth.isSignInWithEmailLink(window.location.href)) {
      let email = localStorage.getItem('emailForSignIn');
      if (!email) {
        email = window.prompt('Please provide your email for confirmation');
      }
      
      if (email) {
        const statusMessage = document.getElementById('auth-status-message');
        if (statusMessage) {
          statusMessage.textContent = "Signing you in...";
          statusMessage.classList.add('text-purple-500');
        }
        
        auth.signInWithEmailLink(email, window.location.href)
          .then((result) => {
            localStorage.removeItem('emailForSignIn');
            showToast('Successfully signed in!', false);
            // Remove the sign-in link from the URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Hide auth modal after successful sign-in
            const authModal = document.getElementById('authModal');
            if (authModal) {
              authModal.classList.add('hidden');
            }

            // Initialize new user if needed
            if (result.additionalUserInfo.isNewUser) {
              return initializeNewUser(result.user);
            }
          })
          .catch((error) => {
            console.error('Error signing in with email link:', error);
            showToast(error.message || 'Error signing in. Please try again.', true);
            if (statusMessage) {
              statusMessage.textContent = "Sign-in failed. Please try again.";
              statusMessage.classList.add('text-red-500');
            }
          });
      }
    }
  }

  // Initialize new user data
  function initializeNewUser(user) {
    const initialData = {
      email: user.email || 'Not Provided',
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      conversations: 0,
      promptsUsed: 0,
      promptsLeft: FREE_PROMPT_LIMIT,
      level: 'Beginner',
      subscribed: false,
      currentConversationId: null,
      successfulReferralCount: 0
    };

    return db.ref(`users/${user.uid}`).set(initialData)
      .then(() => {
        console.log("New user data initialized");
        showToast("Account created successfully!", false);
        // Check for referral
        const referrerId = localStorage.getItem(LS_KEY_REFERRER);
        if (referrerId && referrerId !== user.uid) {
          handleSuccessfulReferral(referrerId);
        }
      })
      .catch(error => {
        console.error("Error initializing user data:", error);
        showToast("Error setting up your account. Some features may be limited.", true);
      });
  }

  // Add Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    handleMagicLinkSignIn();
    
    const emailForm = document.getElementById('email-form');
    if (emailForm) {
      emailForm.addEventListener('submit', sendMagicLink);
    }
    
    const googleBtn = document.getElementById('google-signin-btn');
    if (googleBtn) {
      googleBtn.addEventListener('click', signInWithGoogle);
    }
  });

  // ... rest of your existing code ...

  // Global state variables
  let currentUser = null;
  let currentUserId = null;
  let promptsUsed = 0;
  let promptsLeft = FREE_PROMPT_LIMIT;
  let isSubscribed = false;
  let currentConversationId = null;
  let personalReferralLink = ""; // User's own referral link
  let successfulReferralCount = 0; // How many users successfully signed up via this user's link

  /* ---------------- DOM Element References ---------------- */
  // Cache frequently accessed DOM elements (ensure this runs after DOM is ready or elements exist)
  let domElements = {};
  function cacheDomElements() {
      domElements = {
          authModal: document.getElementById('authModal'),
          subscribeModal: document.getElementById('subscribeModal'),
          shareModal: document.getElementById('shareModal'), // Added
          mainContent: document.getElementById('mainContent'),
          authStatusMessage: document.getElementById('auth-status-message'),
          // authButton: document.getElementById('authButton'), // Removed as login is forced
          logoutButton: document.getElementById('logoutButton'),
          // mobileAuthButton: document.getElementById('mobile-authButton'), // Removed
          mobileLogoutButton: document.getElementById('mobile-logoutButton'),
          recaptchaContainer: document.getElementById('recaptcha-container'),
          emailForm: document.getElementById('email-form'),
          emailInput: document.getElementById('email'),
          emailSubmitBtn: document.getElementById('email-submit-btn'),
          googleSigninBtn: document.getElementById('google-signin-btn'),
          chatContainer: document.getElementById('chat-container'),
          conversationHistorySection: document.getElementById('conversation-history'),
          promptsWarning: document.getElementById('prompts-warning'),
          promptsWarningCount: document.getElementById('prompts-warning-count'),
          userInput: document.getElementById('userInput'),
          sendButton: document.getElementById('sendButton'),
          sendButtonText: document.querySelector('#sendButton .send-btn-text'),
          sendButtonSpinner: document.querySelector('#sendButton .spinner'),
          emailButtonText: document.querySelector('#email-submit-btn .email-btn-text'),
          emailButtonSpinner: document.querySelector('#email-submit-btn .spinner'),
          restartBtn: document.getElementById('restartBtn'),
          toast: document.getElementById('toast'),
          mobileMenuButton: document.getElementById('mobile-menu-button'),
          mobileMenu: document.getElementById('mobile-menu'),
          closeMobileMenuButton: document.getElementById('close-mobile-menu'),
          mobileMenuLinks: document.querySelectorAll('.mobile-menu-link'),
          conversationCountEl: document.getElementById('conversation-count'),
          skillLevelEl: document.getElementById('skill-level'),
          promptsLeftEl: document.getElementById('prompts-left'),
          avatarFrame: document.getElementById('avatarFrame'),
          micButtonIcon: document.querySelector('#micButton i'), // Added Mic icon
          // Share Section Elements
          personalLinkInput: document.getElementById('personalLink'), // Added
          rewardsTextEl: document.getElementById('rewardsText'), // Added
          referralStatusEl: document.getElementById('referralStatus'), // Added
          shareTierButtons: { // Added
              1: document.getElementById('btnTier1'),
              2: document.getElementById('btnTier2'),
              3: document.getElementById('btnTier3')
          }
      };
  }


  let recaptchaVerifier = null; // For phone auth or email link reCAPTCHA

  /* ---------------- Referral Logic ---------------- */

  /**
   * Checks if the current URL contains a referral code ('ref')
   * and stores the potential referrer's UID in localStorage.
   * Also tracks the first visit via a specific link to prevent multiple
   * increments of the 'referralsReceived' counter (analytics).
   */
  function handleReferralVisit() {
      const urlParams = new URLSearchParams(window.location.search);
      const inviterUid = urlParams.get('ref');

      if (inviterUid && inviterUid !== 'undefined' && inviterUid.length > 5) { // Basic validation
          console.log("Referral code detected:", inviterUid);
          // Store inviter UID locally to credit them upon signup
          localStorage.setItem(LS_KEY_REFERRER, inviterUid);

          const visitedKey = LS_KEY_REFERRAL_VISITED_PREFIX + inviterUid;
          // If this is the first time visiting via this specific referral link
          if (!localStorage.getItem(visitedKey)) {
              console.log("First visit via this referral link for inviter:", inviterUid);
              // Increment a counter for analytics (how many clicks the link got)
              const refReceivedPath = `referralsReceived/${inviterUid}`;
              db.ref(refReceivedPath).transaction(currentCount => (currentCount || 0) + 1)
                  .then(() => {
                      console.log("Referral received count updated for", inviterUid);
                      // Mark this specific referral link as visited in localStorage for this browser
                      localStorage.setItem(visitedKey, 'true');
                  })
                  .catch(error => console.error("Failed to update referral received count:", error));
          } else {
               console.log("Already visited via this referral link for inviter:", inviterUid);
          }
          // Optional: Clean the referral code from the URL after processing
          // if (window.history && window.history.replaceState) {
          //     const cleanUrl = window.location.pathname + window.location.hash; // Keep hash for SPA navigation
          //     window.history.replaceState({}, document.title, cleanUrl);
          // }
      }
  }

  /**
   * Called when a new user signs up. Checks if they were referred via a link
   * (by looking for inviterUid in localStorage). If so, records the successful
   * referral and grants bonus prompts to the inviter.
   * @param {string} newUserId - The UID of the newly signed-up user.
   */
  function creditReferrerOnSignUp(newUserId) {
      const inviterUid = localStorage.getItem(LS_KEY_REFERRER);

      // Check if an inviter UID exists, is valid, and is not the new user themselves
      if (inviterUid && inviterUid !== newUserId && inviterUid.length > 5) {
          console.log(`Attempting to credit inviter ${inviterUid} for new user ${newUserId}`);

          const successRefPath = `successfulReferrals/${inviterUid}/${newUserId}`;
          const inviterUserRef = db.ref(`users/${inviterUid}`);

          // Use a transaction on the *successful referral path* to ensure this specific referral
          // is only credited once, even if the function somehow runs multiple times.
          db.ref(successRefPath).transaction(currentData => {
              if (currentData === null) { // Only proceed if this referral hasn't been marked successful yet
                  return firebase.database.ServerValue.TIMESTAMP; // Mark as successful with timestamp
              } else {
                  console.log(`Referral from ${inviterUid} to ${newUserId} already credited.`);
                  return; // Abort transaction - already credited
              }
          })
          .then(result => {
              if (!result.committed) {
                  // Transaction aborted (likely already credited)
                  localStorage.removeItem(LS_KEY_REFERRER); // Clean up local storage anyway
                  return Promise.reject("Referral already credited."); // Stop further processing
              }

              // If transaction committed, it means this referral was successfully marked.
              console.log("Successful referral pair recorded in DB.");

              // Now, increment the inviter's overall successful referral count
              return inviterUserRef.child('successfulReferralCount').transaction(count => (count || 0) + 1);
          })
          .then((result) => {
               if (!result.committed) {
                   console.log("Inviter referral count transaction aborted (maybe concurrent update?).");
                   return Promise.reject("Failed to update inviter count.");
               }
               // If count updated successfully
               const newRefCount = result.snapshot.val();
               console.log(`Inviter ${inviterUid} now has ${newRefCount} successful referrals.`);

               // Grant bonus prompts based on the new count
               grantReferralBonusPrompts(inviterUid, newRefCount);

               // Clean up the stored inviter UID from localStorage after successful processing
               localStorage.removeItem(LS_KEY_REFERRER);
          })
          .catch(error => {
              if (error !== "Referral already credited." && error !== "Failed to update inviter count.") {
                   console.error("Error during referral crediting process:", error);
              }
              // Clean up local storage even if there was an error to prevent retries on next login
              localStorage.removeItem(LS_KEY_REFERRER);
          });
      } else if (inviterUid) {
           // Clear invalid or self-referral inviter keys
           localStorage.removeItem(LS_KEY_REFERRER);
      }
  }

  /**
   * Grants bonus prompts to the inviter based on their new successful referral count.
   * Uses the REFERRAL_PROMPTS_TIERS constant.
   * @param {string} inviterUid - The UID of the user who referred someone.
   * @param {number} newRefCount - The new total number of successful referrals for the inviter.
   */
  function grantReferralBonusPrompts(inviterUid, newRefCount) {
      // Check if the user has already reached the maximum reward tier
      if (newRefCount > MAX_REFERRALS_REWARDED) {
          console.log(`Inviter ${inviterUid} has already reached max referral rewards.`);
          return; // No more rewards beyond the max tier
      }

      // Get the specific bonus amount for reaching this tier
      const promptsToAdd = REFERRAL_PROMPTS_TIERS[newRefCount];

      if (!promptsToAdd) {
          console.log(`No specific prompt reward defined for reaching ${newRefCount} referrals.`);
          return; // No reward defined for this specific count
      }

      console.log(`Attempting to grant ${promptsToAdd} bonus prompts to inviter ${inviterUid} for reaching ${newRefCount} referrals.`);

      const inviterUserRef = db.ref(`users/${inviterUid}`);

      // Use a transaction to safely add prompts to the inviter's count
      inviterUserRef.child('promptsLeft').transaction(currentPrompts => {
          // Ensure we handle null/undefined cases for promptsLeft
          const currentVal = (typeof currentPrompts === 'number') ? currentPrompts : 0;
          // Add the bonus prompts for reaching this tier
          return currentVal + promptsToAdd;
      }).then((result) => {
          if (result.committed) {
               const finalPromptCount = result.snapshot.val();
               console.log(`Granted ${promptsToAdd} bonus prompts to inviter ${inviterUid}. New total: ${finalPromptCount}`);
               // Optionally, push a notification to the inviter in the database
               db.ref(`notifications/${inviterUid}`).push({
                   type: 'referral_bonus',
                   message: `You earned ${promptsToAdd} free prompts for referring your ${getOrdinal(newRefCount)} friend!`,
                   timestamp: firebase.database.ServerValue.TIMESTAMP,
                   read: false
               });
          } else {
              console.log(`Transaction to add bonus prompts for inviter ${inviterUid} aborted (maybe concurrent update?).`);
          }
      }).catch(error => {
          console.error(`Error granting bonus prompts to inviter ${inviterUid}:`, error);
      });
  }

  // Helper function for ordinal numbers (1st, 2nd, 3rd)
  function getOrdinal(n) {
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
  }

  /* ---------------- Authentication State Listener ---------------- */
  auth.onAuthStateChanged(user => {
      // Ensure DOM elements are cached before proceeding
      if (Object.keys(domElements).length === 0) {
          console.warn("DOM elements not cached yet in onAuthStateChanged");
          cacheDomElements(); // Attempt to cache if not already done
          if (Object.keys(domElements).length === 0) return; // Still failed, exit
      }

      if (user) {
          // --- User is SIGNED IN ---
          // Check if this is the first time the user is signing in with this account
          const isNewUser = user.metadata.creationTime === user.metadata.lastSignInTime;
          currentUser = user;
          currentUserId = user.uid;
          console.log("User signed in:", currentUserId, "Is new user:", isNewUser);

          // Generate personal referral link
          personalReferralLink = `${window.location.origin}${window.location.pathname}?ref=${currentUserId}`;
          if(domElements.personalLinkInput) domElements.personalLinkInput.value = personalReferralLink;

          updateAuthUI(true); // Update nav buttons (show logout)

          // ** Hide Auth Modal and Unblur Background **
          domElements.authModal?.classList.add('hidden');
          domElements.mainContent?.classList.remove('blur-background');

          loadUserData(currentUserId); // Load user data (includes fetching referral count)

          // If it's the very first sign-in for this user, check if they were referred
          if (isNewUser) {
              creditReferrerOnSignUp(currentUserId);
          }
      } else {
          // --- User is SIGNED OUT ---
          console.log("User signed out.");
          currentUser = null;
          currentUserId = null;
          personalReferralLink = "";
          successfulReferralCount = 0;

          updateAuthUI(false); // Update nav buttons (hide logout)
          resetAppState(); // Reset prompts, chat, etc.
          updateShareSectionUI(); // Update share section

          // ** Force Auth Modal Open and Blur Background **
          openAuthModal(); // This now handles showing modal and blurring
      }
  // Force auth modal visible until Firebase finishes auth check
  if (!firebase.auth().currentUser) openAuthModal();
  });

  /* ---------------- UI Update Functions ---------------- */

  // Updates nav buttons based on auth state
  function updateAuthUI(isSignedIn) {
      const showIfSignedIn = [domElements.logoutButton, domElements.mobileLogoutButton];
      if (isSignedIn) {
          showIfSignedIn.forEach(el => el?.classList.remove('hidden'));
      } else {
          showIfSignedIn.forEach(el => el?.classList.add('hidden'));
      }
  }

  // Resets UI elements and state
  function resetAppState() {
    promptsUsed               = 0;
    promptsLeft               = FREE_PROMPT_LIMIT;
    isSubscribed              = false;
    currentConversationId     = null;

    if (domElements.conversationCountEl)
      domElements.conversationCountEl.textContent = '0';
    if (domElements.skillLevelEl)
      domElements.skillLevelEl.textContent       = 'Beginner';
    if (domElements.promptsLeftEl)
      domElements.promptsLeftEl.textContent      = FREE_PROMPT_LIMIT;
    if (domElements.chatContainer)
      domElements.chatContainer.innerHTML        = '';

    domElements.conversationHistorySection?.classList.add('hidden');
    domElements.restartBtn?.classList.add('hidden');

    if (!domElements.promptsWarning) {
      console.error('promptsWarning element missing in DOM');
    } else {
      domElements.promptsWarning.classList.add('hidden');
    }
  }   // ← exactly one brace closes the function

  // Shows/hides loading indicators on buttons
  function showButtonLoading(button, textElement, spinnerElement, isLoading) {
       if (!button || !textElement || !spinnerElement) return;
      if (isLoading) {
          button.disabled = true;
          textElement.classList.add('hidden');
          spinnerElement.classList.remove('hidden');
      } else {
          button.disabled = false;
          textElement.classList.remove('hidden');
          spinnerElement.classList.add('hidden');
      }
  }

  /* ---------------- User Data Management (Firebase RTDB) ---------------- */
  function loadUserData(userId) {
      showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, true);
      const userRef = db.ref(`users/${userId}`);
      userRef.once('value')
          .then(snapshot => {
              const userData = snapshot.val();
              if (userData) {
                  // User exists, load their data
                  console.log("Loaded user data:", userData);
                  promptsUsed = userData.promptsUsed || 0;
                  // Load promptsLeft, ensure it's a number, default to FREE_LIMIT if missing/invalid
                  promptsLeft = (typeof userData.promptsLeft === 'number') ? Math.max(0, userData.promptsLeft) : FREE_PROMPT_LIMIT;
                  isSubscribed = userData.subscribed || false;
                  currentConversationId = userData.currentConversationId || null;
                  // Load successful referral count
                  successfulReferralCount = userData.successfulReferralCount || 0;

                  // Update UI Stats
                  if (domElements.conversationCountEl) domElements.conversationCountEl.textContent = userData.conversations || 0;
                  if (domElements.skillLevelEl) domElements.skillLevelEl.textContent = userData.level || 'Beginner';

                  // Load chat history
                  loadChatHistory(userId, currentConversationId);

              } else {
                  // New user, initialize their data
                  console.log("New user detected, initializing data for:", userId);
                  const initialData = {
                      email: currentUser.email || 'Not Provided',
                      createdAt: firebase.database.ServerValue.TIMESTAMP,
                      conversations: 0, promptsUsed: 0, promptsLeft: FREE_PROMPT_LIMIT,
                      level: 'Beginner', subscribed: false, currentConversationId: null,
                      successfulReferralCount: 0 // Initialize referral count
                  };
                  userRef.set(initialData)
                      .then(() => {
                          console.log("Initial user data saved.");
                          // Set initial state variables after saving defaults
                          promptsLeft = FREE_PROMPT_LIMIT;
                          successfulReferralCount = 0;
                          isSubscribed = false;
                          currentConversationId = null;
                          promptsUsed = 0;
                          // Update UI based on these initial values
                          updatePromptsUI();
                          checkSubscriptionStatus();
                          updateShareSectionUI();
                          resetAppState(); // Reset UI elements like chat
                      })
                      .catch(error => console.error("Error saving initial user data:", error));
                   // Don't proceed with UI updates until data is potentially saved
                   return; // Exit early, UI will update after save or on error
              }

              // Update UI based on loaded/initialized data
              updatePromptsUI();
              checkSubscriptionStatus();
              updateShareSectionUI(); // Update share section based on referral count

          })
          .catch(error => {
              console.error("Error loading user data:", error);
              showToast("Error loading your data. Using defaults.", true);
              resetAppState(); // Fallback to default state
              updateShareSectionUI(); // Update share section for error state
          })
          .finally(() => {
              // Ensure loading indicator is hidden even if new user init happened
              showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, false);
          });
  }
  function updateUserData(userId, data) {
      if (!userId) return Promise.reject("No user ID provided for update.");
      console.log("Updating user data:", userId, data);
      return db.ref(`users/${userId}`).update(data);
  }
  function loadChatHistory(userId, conversationId) {
      if (!userId || !conversationId) {
          domElements.conversationHistorySection?.classList.add('hidden');
          if(domElements.chatContainer) domElements.chatContainer.innerHTML = '';
          domElements.restartBtn?.classList.add('hidden'); return;
      }
      const chatRef = db.ref(`chats/${userId}/${conversationId}`);
      chatRef.orderByChild('timestamp').once('value')
          .then(snapshot => {
              if(domElements.chatContainer) domElements.chatContainer.innerHTML = '';
              if (snapshot.exists()) {
                  domElements.conversationHistorySection?.classList.remove('hidden');
                  domElements.restartBtn?.classList.remove('hidden');
                  let messages = [];
                  snapshot.forEach(childSnapshot => messages.push(childSnapshot.val()));
                  messages.forEach(msg => addMessageToHistory(msg.text, msg.sender));
                  if (messages.length > 0) {
                      localStorage.setItem(LS_KEY_CHAT, JSON.stringify(messages.map(m => ({text: m.text, sender: m.sender}))));
                  } else {
                       localStorage.removeItem(LS_KEY_CHAT); // Clear if DB empty
                  }
              } else {
                  domElements.conversationHistorySection?.classList.add('hidden');
                  domElements.restartBtn?.classList.add('hidden');
                  localStorage.removeItem(LS_KEY_CHAT);
              }
          }).catch(error => { console.error("Error loading chat history:", error); showToast("Could not load conversation history.", true); });
  }
  function updatePromptsUI() {
      if (!domElements.promptsLeftEl || !domElements.promptsWarning || !domElements.promptsWarningCount) return;
      domElements.promptsLeftEl.textContent = isSubscribed ? '∞' : promptsLeft;
      if (!isSubscribed && promptsLeft <= 1 && promptsLeft >= 0) {
          domElements.promptsWarning.classList.remove('hidden');
          domElements.promptsWarningCount.textContent = promptsLeft;
      } else {
          domElements.promptsWarning.classList.add('hidden');
      }
  }
  function checkSubscriptionStatus() {
      if (!isSubscribed && promptsLeft <= 0) { disableSendButton(); }
      else { enableSendButton(); }
  }

  // Updates the Share section UI based on login status and referral count
  // ------------------------------------------------------------------
  function updateShareSectionUI() {
    if (!domElements.rewardsTextEl ||
        !domElements.referralStatusEl ||
        !domElements.shareTierButtons[1]) return;   // Safety‑check

    // ---------- Logged‑OUT state ----------
    if (!currentUser) {
      domElements.rewardsTextEl.textContent =
        "Log in to start sharing & earn free prompts!";
      domElements.referralStatusEl.textContent = "";

      // Disable ALL tier buttons
      Object.values(domElements.shareTierButtons).forEach(btn => {
        if (!btn) return;
        btn.classList.add('disabled');
        btn.disabled = true;
      });

      if (domElements.personalLinkInput)
        domElements.personalLinkInput.value = "Log in to get your link";
      return;                    // ← exit early; nothing more to do
    }

    // ---------- Logged‑IN state ----------
    const count = successfulReferralCount;
    let rewardText = "";
    let statusText =
        `You have successfully referred ${count} friend${count === 1 ? '' : 's'}.`;

    if (count >= MAX_REFERRALS_REWARDED) {
      rewardText = "You've earned the maximum referral reward! 🎉";
      statusText += " Thanks for sharing!";
    } else if (count === 2) {
      rewardText = `Refer one more friend to unlock +${REFERRAL_PROMPTS_TIERS[3]} free prompts!`;
    } else if (count === 1) {
      rewardText = `Refer ${MAX_REFERRALS_REWARDED - count} more friends for more rewards!`;
    } else { // count === 0
      rewardText = "Share with friends and earn free prompts!";
      statusText = "Start sharing to track your progress.";
    }

    domElements.rewardsTextEl.textContent   = rewardText;
    domElements.referralStatusEl.textContent = statusText;

    // Disable buttons only if user already hit the max tier
    Object.values(domElements.shareTierButtons).forEach(btn => {
      if (!btn) return;
      if (count >= MAX_REFERRALS_REWARDED) {
        btn.classList.add('disabled');
        btn.disabled = true;
      } else {
        btn.classList.remove('disabled');
        btn.disabled = false;
      }
    });

    if (domElements.personalLinkInput)
      domElements.personalLinkInput.value = personalReferralLink;
  }

  /* ---------------- Modal Management ---------------- */
  function openAuthModal() {
      domElements.authModal?.classList.remove('hidden');
      domElements.mainContent?.classList.add('blur-background');
      clearStatusMessage();
  }
  function openSubscribeModal() {
      domElements.subscribeModal?.classList.remove('hidden');
      domElements.mainContent?.classList.add('blur-background');
  }
  function closeSubscribeModal() {
      domElements.subscribeModal?.classList.add('hidden');
      domElements.mainContent?.classList.remove('blur-background');
  }
  function openShareModal() {
      if (!currentUser) { showToast("Please log in to share.", true); return; }
      domElements.shareModal?.classList.remove('hidden');
  }
  function closeShareModal() {
      domElements.shareModal?.classList.add('hidden');
  }
  function showStatusMessage(msg, isError = false) {
      const el = domElements.authStatusMessage; if (!el) return;
      el.textContent = msg;
      el.className = `text-center text-sm mt-3 min-h-[1.2em] ${isError ? 'text-red-600' : 'text-green-600'}`;
  }
  function clearStatusMessage() {
       const el = domElements.authStatusMessage; if (!el) return;
      el.textContent = '';
      el.className = 'text-center text-sm mt-3 min-h-[1.2em]';
  }

  /* ---------------- Authentication Actions ---------------- */
  function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      if (domElements.googleSigninBtn) {
          domElements.googleSigninBtn.disabled = true;
          domElements.googleSigninBtn.classList.add('opacity-75');
      }
      auth.signInWithPopup(provider)
          .then((result) => { console.log("Google sign-in successful"); }) // onAuthStateChanged handles UI
          .catch((error) => { console.error("Google sign-in error:", error); showStatusMessage(`Google sign-in failed: ${error.message}`, true); })
          .finally(() => { if (domElements.googleSigninBtn) { domElements.googleSigninBtn.disabled = false; domElements.googleSigninBtn.classList.remove('opacity-75'); }});
  }

  function sendMagicLink(event) {
      event.preventDefault();
      const email = domElements.emailInput?.value?.trim(); // FIXED: Added definition

      if (!email || !email.includes('@')) {
          showStatusMessage("Please enter a valid email address.", true);
          return;
      }

      const actionCodeSettings = {
          url: "https://izzy-auth.web.app", // ← Must match Firebase console
          handleCodeInApp: true,
      };

      showButtonLoading(domElements.emailSubmitBtn, domElements.emailButtonText, domElements.emailButtonSpinner, true);

      auth.sendSignInLinkToEmail(email, actionCodeSettings)
          .then(() => {
              window.localStorage.setItem('emailForSignIn', email);
              showStatusMessage(`Check your email (${email}) for a sign-in link!`, false);
              domElements.emailInput.value = '';
          })
          .catch((error) => {
              console.error("Error sending magic link:", error);
              showStatusMessage(`Error: ${error.message}`, true);
          })
          .finally(() => {
              showButtonLoading(domElements.emailSubmitBtn, domElements.emailButtonText, domElements.emailButtonSpinner, false);
          });
  }

  /* ---------------- Chat Functionality ---------------- */
  function addMessageToHistory(text, sender = 'user') {
       if (!domElements.chatContainer) return;
       const bubble = document.createElement('div');
      bubble.classList.add('chat-bubble');
      bubble.classList.add(sender === 'user' ? 'user-bubble' : 'assistant-bubble');
      bubble.textContent = text;
      domElements.chatContainer.appendChild(bubble);
      domElements.chatContainer.scrollTop = domElements.chatContainer.scrollHeight;
      domElements.conversationHistorySection?.classList.remove('hidden');
      domElements.restartBtn?.classList.remove('hidden');
  }
  function saveMessage(userId, conversationId, text, sender) {
       if (!userId || !conversationId) return Promise.reject("Missing user or conversation ID for saving message.");
      const chatRef = db.ref(`chats/${userId}/${conversationId}`);
      const newMessageRef = chatRef.push();
      const messageData = { text: text, sender: sender, timestamp: firebase.database.ServerValue.TIMESTAMP };
      return newMessageRef.set(messageData).then(() => {
          const localChat = JSON.parse(localStorage.getItem(LS_KEY_CHAT) || '[]');
          localChat.push({ text, sender });
          localStorage.setItem(LS_KEY_CHAT, JSON.stringify(localChat));
      });
  }
  function sendMessage() {
      const messageText = domElements.userInput.value.trim();
      if (!messageText) return;
      if (!currentUser || !currentUserId) { return; } // Should not happen with forced login
      if (!isSubscribed && promptsLeft <= 0) { openSubscribeModal(); showToast("Please subscribe to continue chatting.", true); disableSendButton(); return; }
      showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, true);
      addMessageToHistory(messageText, 'user');
      if (!currentConversationId) {
          currentConversationId = db.ref(`chats/${currentUserId}`).push().key;
          updateUserData(currentUserId, { currentConversationId: currentConversationId, conversations: firebase.database.ServerValue.increment(1) })
              .catch(err => console.error("Failed to update conversation ID/count:", err));
      }
      saveMessage(currentUserId, currentConversationId, messageText, 'user')
          .catch(error => { console.error("Failed to save user message:", error); showToast("Error sending message. Please try again.", true); });
      // --- Simulate AI Response ---
      const simulateApiCall = new Promise((resolve) => { setTimeout(() => { const responses = ["That's interesting! Tell me more.", "Okay, I see. What happened next?", "How did that make you feel?", "Hmm, let's think about that.", "Got it. What's on your mind now?", "Can you elaborate on that point?", "What are your thoughts on trying this approach...?"]; resolve(responses[Math.floor(Math.random() * responses.length)]); }, 1500); });
      simulateApiCall.then(aiResponse => { addMessageToHistory(aiResponse, 'assistant'); return saveMessage(currentUserId, currentConversationId, aiResponse, 'assistant'); })
  .then(() => { if (!isSubscribed) { return db.ref(`users/${currentUserId}`).transaction(userData => { if (userData) { userData.promptsLeft = Math.max(0, (userData.promptsLeft || 0) - 1); userData.promptsUsed = (userData.promptsUsed || 0) + 1; } return userData; }); } return Promise.resolve(); }) // Use transaction for prompt decrement
   .then((result) => { if (!isSubscribed && result.committed) { promptsLeft = result.snapshot.val().promptsLeft; promptsUsed = result.snapshot.val().promptsUsed; updatePromptsUI(); checkSubscriptionStatus(); localStorage.setItem(LS_KEY_PROMPTS, promptsLeft); } })
  .catch(error => { console.error("Error processing/saving AI response or updating prompts:", error); showToast("Error getting response. Please try again.", true); addMessageToHistory("Sorry, I encountered an error.", 'assistant'); })
  .finally(() => { showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, false); domElements.userInput.value = ''; domElements.userInput.focus(); });
   console.log("TODO: Trigger D-ID avatar to speak:", "...");
  }
  function restartConversation() {
       if (!currentUser || !currentUserId) return;
      console.log("Restarting conversation for user:", currentUserId);
      const newConversationId = db.ref(`chats/${currentUserId}`).push().key;
      updateUserData(currentUserId, { currentConversationId: newConversationId, conversations: firebase.database.ServerValue.increment(1) })
          .then(() => {
              currentConversationId = newConversationId;
              if(domElements.chatContainer) domElements.chatContainer.innerHTML = '';
              domElements.conversationHistorySection?.classList.add('hidden');
              domElements.restartBtn?.classList.add('hidden');
              localStorage.removeItem(LS_KEY_CHAT);
              showToast("New conversation started.");
              domElements.userInput.value = ''; domElements.userInput.focus();
          })
          .catch(error => { console.error("Error restarting conversation:", error); showToast("Could not restart conversation. Please try again.", true); });
  }

  /* ---------------- Voice Input (Web Speech API) ---------------- */
  let recognition = null;
  function startDictation() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { showToast("Sorry, your browser doesn't support voice input.", true); return; }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!recognition) {
           recognition = new SpeechRecognition();
           recognition.lang = 'en-US'; recognition.interimResults = false; recognition.maxAlternatives = 1;
           recognition.onstart = () => { recognition.isListening = true; domElements.micButtonIcon?.classList.add('text-red-500', 'fa-beat'); showToast("Listening...", false, 2000); };
           recognition.onresult = (event) => { if(domElements.userInput) domElements.userInput.value = event.results[0][0].transcript; };
           recognition.onspeechend = () => { recognition.stop(); };
           recognition.onend = () => { recognition.isListening = false; domElements.micButtonIcon?.classList.remove('text-red-500', 'fa-beat'); };
           recognition.onerror = (event) => { let errorMsg = "Voice recognition error."; if (event.error === 'no-speech') errorMsg = "No speech detected."; else if (event.error === 'audio-capture') errorMsg = "Microphone error."; else if (event.error === 'not-allowed') errorMsg = "Permission denied."; showToast(errorMsg, true); recognition.isListening = false; domElements.micButtonIcon?.classList.remove('text-red-500', 'fa-beat'); };
      }
      if (recognition.isListening) { recognition.stop(); }
      else { try { recognition.start(); } catch (error) { console.error("Failed to start SpeechRecognition:", error); showToast("Could not start voice input.", true); recognition.isListening = false; domElements.micButtonIcon?.classList.remove('text-red-500', 'fa-beat'); } }
  }


  /* ---------------- Share Functionality ---------------- */
  function shareVia(channel) {
      if (!currentUser) { showToast("Please log in first to share.", true); return; }
      if (!personalReferralLink) { showToast("Could not generate your referral link.", true); return; }
      const url = encodeURIComponent(personalReferralLink);
      const text = encodeURIComponent("Check out IZZY – the AI conversation coach that helps build real confidence!");
      let shareURL = "#";
      switch (channel) {
          case 'whatsapp': shareURL = `https://api.whatsapp.com/send?text=${text}%20${url}`; break;
          case 'email': shareURL = `mailto:?subject=Try%20IZZY%20-%20AI%20Conversation%20Coach&body=${text}%0A%0A${url}`; break;
          case 'facebook': shareURL = `https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`; break;
          case 'twitter': shareURL = `https://twitter.com/intent/tweet?text=${text}&url=${url}`; break;
          case 'reddit': shareURL = `https://www.reddit.com/submit?url=${url}&title=${encodeURIComponent("Try IZZY - AI Conversation Coach")}`; break;
          default: console.warn("Unknown share channel:", channel); return;
      }
      window.open(shareURL, '_blank');
      db.ref(`shareAttempts/${currentUserId}`).push({ channel: channel, timestamp: firebase.database.ServerValue.TIMESTAMP });
      showToast("Sharing link opened!", false);
  }
  function copyReferralLink() {
      if (!domElements.personalLinkInput) return;
      try {
          domElements.personalLinkInput.select();
          if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(domElements.personalLinkInput.value)
                  .then(() => showToast("Link copied to clipboard!", false))
                  .catch(err => { document.execCommand('copy'); showToast("Link copied (fallback method)!", false); });
          } else { document.execCommand('copy'); showToast("Link copied (fallback method)!", false); }
      } catch (err) { console.error('Failed to copy link:', err); showToast("Could not copy link.", true); }
      window.getSelection()?.removeAllRanges();
  }


  /* ---------------- Utility Functions ---------------- */
  let toastTimeout;
  function showToast(message, isError = false, duration = 3000) {
      clearTimeout(toastTimeout);
      if (!domElements.toast) return;
      domElements.toast.textContent = message;
      domElements.toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 z-[120] ${isError ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
      requestAnimationFrame(() => { domElements.toast.classList.remove('translate-y-full', 'opacity-0'); domElements.toast.classList.add('translate-y-0', 'opacity-100'); });
      toastTimeout = setTimeout(() => { domElements.toast.classList.remove('translate-y-0', 'opacity-100'); domElements.toast.classList.add('translate-y-full', 'opacity-0'); }, duration);
  }
  function usePrompt(promptText) { if(domElements.userInput) { domElements.userInput.value = promptText; domElements.userInput.focus(); } }
  function disableSendButton() { if (!domElements.sendButton) return; domElements.sendButton.disabled = true; domElements.sendButton.classList.add('opacity-50', 'cursor-not-allowed'); }
  function enableSendButton() { if (!domElements.sendButton) return; domElements.sendButton.disabled = false; domElements.sendButton.classList.remove('opacity-50', 'cursor-not-allowed'); }


  /* ---------------- Event Listeners ---------------- */
  function addEventListeners() {
      // Auth buttons (inside modal)
      domElements.googleSigninBtn?.addEventListener('click', signInWithGoogle);
      domElements.emailForm?.addEventListener('submit', sendMagicLink);

      // Logout buttons
      domElements.logoutButton?.addEventListener('click', logout);
      domElements.mobileLogoutButton?.addEventListener('click', () => { logout(); closeMobileMenu(); });

      // Chat buttons & Input
      domElements.sendButton?.addEventListener('click', sendMessage);
      domElements.restartBtn?.addEventListener('click', restartConversation);
      domElements.userInput?.addEventListener('keydown', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });
      domElements.micButtonIcon?.parentElement.addEventListener('click', startDictation);

      // Mobile Menu
      domElements.mobileMenuButton?.addEventListener('click', toggleMobileMenu);
      domElements.closeMobileMenuButton?.addEventListener('click', closeMobileMenu);
      domElements.mobileMenuLinks?.forEach(link => {
          link.addEventListener('click', (e) => { if (link.getAttribute('href')?.startsWith('#') || link.tagName === 'BUTTON') { closeMobileMenu(); } });
      });

      // Close OTHER modals on backdrop click (Auth modal backdrop click is disabled)
      domElements.subscribeModal?.addEventListener('click', (e) => { if (e.target === domElements.subscribeModal) closeSubscribeModal(); });
      domElements.shareModal?.addEventListener('click', (e) => { if (e.target === domElements.shareModal) closeShareModal(); });

      // Share section listeners
      domElements.personalLinkInput?.addEventListener('click', copyReferralLink);
      Object.values(domElements.shareTierButtons).forEach(button => { if(button) button.addEventListener('click', openShareModal); });

      Object.entries(domElements).forEach(([key, el]) => {
    if (!el) console.warn(`Missing DOM element for ${key}`);
  });

  // --- magic‑prompt buttons ---
  document.getElementById('promptCoffee')
    ?.addEventListener('click', () => usePrompt('Hi, I noticed you at the coffee shop'));
  document.getElementById('promptIntro')
    ?.addEventListener('click', () => usePrompt('Excuse me, I just wanted to introduce myself'));
  document.getElementById('promptCompliment')
    ?.addEventListener('click', () => usePrompt('I like your style, where did you get that?'));


      // Subscription buttons listener
      const mainSubButtons = document.querySelectorAll('#subscribe .plan-card a[target="_blank"]');
      mainSubButtons.forEach(button => {
          button.addEventListener('click', (e) => {
              if (!currentUser) { e.preventDefault(); showToast("Please log in before subscribing.", true); }
              else { console.log("Proceeding to subscription:", button.href); }
          });
      });
  }


  /* ---------------- Mobile Menu Logic ---------------- */
  function toggleMobileMenu() { const isOpen = domElements.mobileMenu.classList.contains('open'); if (isOpen) closeMobileMenu(); else openMobileMenu(); }
  function openMobileMenu() { if(domElements.mobileMenu) domElements.mobileMenu.classList.add('open'); domElements.mobileMenuButton?.setAttribute('aria-expanded', 'true'); }
  function closeMobileMenu() { if(domElements.mobileMenu) domElements.mobileMenu.classList.remove('open'); domElements.mobileMenuButton?.setAttribute('aria-expanded', 'false'); }


  /* ---------------- Initialization ---------------- */
  document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM fully loaded and parsed");

      // Hide auth modal initially to prevent flash of unstyled content
      const authModal = document.getElementById('authModal');
      if (authModal) {
          authModal.style.visibility = 'hidden';
      }

      // Wait for Tailwind and other resources to load
      window.addEventListener('load', () => {
          // Cache DOM elements needed by scripts
          cacheDomElements();

          // Check for magic link sign-in attempt immediately
          handleMagicLinkSignIn();

          // Add all event listeners
          addEventListeners();

          // Call referral visit handler
          handleReferralVisit();

          // Show auth modal if needed (after styles are loaded)
          if (authModal) {
              authModal.style.visibility = 'visible';
              if (!firebase.auth().currentUser) {
                  openAuthModal();
              }
          }

          // Load data from localStorage backups
          const localPrompts = localStorage.getItem(LS_KEY_PROMPTS);
          if (localPrompts !== null && !isSubscribed) {
              promptsLeft = parseInt(localPrompts, 10);
              console.log("Restored prompts left from localStorage:", promptsLeft);
              updatePromptsUI();
          }
          const localChat = JSON.parse(localStorage.getItem(LS_KEY_CHAT) || '[]');
          if (localChat.length > 0 && domElements.chatContainer && domElements.chatContainer.children.length === 0) {
              console.log("Restoring chat from localStorage backup.");
              localChat.forEach(msg => addMessageToHistory(msg.text, msg.sender));
          }
      });
  });

  /* ---------- Ask for microphone permission on load ---------- */
  function requestMicPermission() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        // Immediately stop tracks – we just needed the permission
        stream.getTracks().forEach(t => t.stop());
        console.log("Microphone permission granted");
      })
      .catch(err => {
        console.warn("Mic permission denied:", err);
      });
  }
  document.addEventListener('DOMContentLoaded', requestMicPermission);
  </script>

</body>
</html>
