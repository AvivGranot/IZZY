<!DOCTYPE html>
<html lang="en">
<head>

  <meta name="description" content="Practice real conversations with IZZY, the AI avatar coach.">
  <meta property="og:title"       content="IZZY – AI Avatar for Real Conversations">
  <meta property="og:description" content="Practice real conversations with IZZY, the AI avatar coach.">
  <meta property="og:url" content="https://izzy-auth.web.app">  <meta property="og:type"        content="website">
  <meta property="og:image" content="https://izzy-auth.web.app/img/og.png">
  <meta property="og:image:alt"   content="Screenshot of IZZY AI avatar app">


  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IZZY – AI Avatar for Real Conversations</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />


  <style>
    /* Basic Reset & Font */
    * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; } /* Added smooth scroll */
    body { font-family: 'Inter', sans-serif; background: #fff; color:#333; }

    /* Backdrop-blur card effect */
    .glass {
      background: rgba(255,255,255,0.85); /* Semi-transparent white */
      backdrop-filter: blur(10px); /* Blur effect */
      -webkit-backdrop-filter: blur(10px); /* Safari support */
      border-radius: 1rem; /* Rounded corners */
      padding: 2rem; /* Padding */
      box-shadow: 0 20px 25px rgba(0,0,0,0.05); /* Subtle shadow */
      border: 1px solid rgba(255, 255, 255, 0.2); /* Optional subtle border */
    }

    /* Blur background behind modals */
    .blur-background { filter: blur(8px); pointer-events:none; }

    /* Simple fade-in animation */
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:none;} }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }

    /* Hidden helper class */
    .visually-hidden { display:none; }

    /* Chat bubble styling */
    .chat-bubble {
      border-radius: 18px; /* Rounded bubbles */
      padding: 10px 15px; /* Padding inside bubbles */
      max-width: 80%; /* Max width to prevent full width */
      margin-bottom: 10px; /* Spacing between bubbles */
      word-wrap: break-word; /* Ensure long words break */
    }
    .user-bubble {
      background-color: #E9F3FF; /* Light blue for user */
      margin-left: auto; /* Align to the right */
      border-bottom-right-radius: 4px; /* Slightly less round corner */
    }
    .assistant-bubble {
      background-color: #F2F2F7; /* Light gray for assistant */
      margin-right: auto; /* Align to the left */
      border-bottom-left-radius: 4px; /* Slightly less round corner */
    }

    /* Focus states for better accessibility */
    button:focus, input:focus, a:focus, iframe:focus, textarea:focus { /* Added textarea */
      outline: 2px solid #8B5CF6; /* Purple outline */
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3); /* Optional softer glow */
    }
    /* Remove default iframe border if focused */
    iframe:focus {
        border: none;
    }


    /* Loading spinner animation */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3); /* Light border */
      border-radius: 50%; /* Circle */
      border-top: 3px solid #8B5CF6; /* Purple top border for spin effect */
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile responsiveness for Navigation */
    @media (max-width: 640px) {
      .mobile-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 100; /* Ensure it's above other content */
        padding: 2rem;
        transform: translateX(-100%); /* Start off-screen */
        transition: transform 0.3s ease;
        display: flex; /* Use flex for layout */
        flex-direction: column; /* Stack items vertically */
      }

      .mobile-menu.open {
        transform: translateX(0); /* Slide in */
      }

      .desktop-nav {
        display: none; /* Hide desktop nav on small screens */
      }

      .mobile-nav-button {
        display: block; /* Show mobile button */
      }
    }

    @media (min-width: 641px) {
      .mobile-nav-button {
        display: none; /* Hide mobile button on large screens */
      }

      .mobile-menu {
        display: none; /* Hide mobile menu */
      }

      .desktop-nav {
        display: flex; /* Show desktop nav */
      }
    }

    /* Styles from subscribe.html */
    .plan-card {
      transition: all 0.3s ease;
    }
    .plan-card:hover {
      transform: translateY(-8px);
    }
    .popular-badge {
      position: absolute;
      top: -12px;
      right: 20px;
      background: linear-gradient(to right, #9333ea, #ec4899);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .gradient-border {
      position: relative;
      border-radius: 1rem;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(to right, #9333ea, #ec4899) border-box;
      border: 2px solid transparent;
    }

    /* Styles from share.html */
    .share-button{transition:all .3s ease}
    .share-button:hover{transform:translateY(-3px)}
    .gradient-card{background:linear-gradient(white,white) padding-box,
                    linear-gradient(to right,#9333ea,#ec4899) border-box;border:2px solid transparent;border-radius:1rem}
    .gradient-bg{background:linear-gradient(135deg,rgba(147,51,234,.08),rgba(236,72,153,.08))}
    .disabled{opacity:.5;cursor:not-allowed !important;transform:none !important}

  </style>

  <script>
    // Extend Tailwind theme with custom colors
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'izzy-blue': '#0047AB', // Custom blue
            'izzy-purple': { // Custom purple shades
              500: '#8B5CF6',
              600: '#7C3AED',
              700: '#6D28D9'
            },
            'izzy-pink': { // Custom pink shades
              500: '#EC4899',
              600: '#DB2777'
            }
          },
        }
      },
    }
  </script>
</head>

<body class="text-gray-900 antialiased"> <div id="authModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-50 p-4">
  <div class="bg-white rounded-3xl shadow-2xl p-6 sm:p-8 max-w-md w-full fade-in">
    <div class="flex justify-center mb-6">
      <div class="bg-gradient-to-r from-izzy-pink-500 to-izzy-purple-500 rounded-full w-16 h-16 flex items-center justify-center">
        <span class="text-white text-2xl font-bold">IZZY</span>
      </div>
    </div>
    <div class="text-center mb-8">
      <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900">Real Conversations.</h1>
      <h2 class="text-2xl sm:text-3xl font-semibold text-gray-900 mb-4">Real Confidence.</h2>
      <p class="text-gray-600">Sign up or log in with your email to continue.</p>
    </div>

    <form id="email-form">
      <label for="email" class="sr-only">Email address</label>
      <input type="email" id="email" placeholder="Enter your email"
             aria-label="Email address"
             class="w-full px-4 py-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-izzy-purple-500 mb-3"
             required />
      <button type="submit" id="email-submit-btn"
        class="w-full py-3 rounded-full text-white font-semibold bg-gradient-to-r from-izzy-purple-500 to-izzy-pink-500 hover:from-izzy-purple-600 hover:to-izzy-pink-600 transition-all duration-300 flex items-center justify-center">
        <span class="email-btn-text">Send Magic Link</span>
        <span class="spinner hidden ml-2"></span>
      </button>
    </form>
    
    <!-- Email verification form (hidden by default) -->
    <div id="verification-form-container" class="hidden">
      <div class="text-center mb-4">
        <p class="font-medium">Please enter the email address you used to request the magic link:</p>
      </div>
      <input type="email" id="verification-email" placeholder="Your email address"
             class="w-full px-4 py-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-izzy-purple-500 mb-3" />
      <button id="verify-link-btn"
        class="w-full py-3 rounded-full text-white font-semibold bg-gradient-to-r from-izzy-purple-500 to-izzy-pink-500 hover:from-izzy-purple-600 hover:to-izzy-pink-600 transition-all duration-300 flex items-center justify-center">
        <span id="verify-link-text">Complete Sign-In</span>
        <span id="verify-link-spinner" class="hidden ml-2 spinner"></span>
      </button>
    </div>

    <div id="auth-status-message" class="text-center text-sm mt-3 min-h-[1.2em]"></div>

    <p class="text-center text-xs text-gray-500 mt-4">
      By continuing, you agree to our
      <a href="#terms" class="text-izzy-purple-500 hover:underline">Terms</a> & 
      <a href="#privacy" class="text-izzy-purple-500 hover:underline">Privacy</a>.
    </p>
  </div>
</div>

<div id="subscribeModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-50 hidden p-4"> <div class="bg-white rounded-3xl shadow-2xl p-6 sm:p-8 max-w-md w-full fade-in relative"> <button onclick="closeSubscribeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" aria-label="Close subscription modal">
        <i class="fas fa-times text-xl"></i>
    </button>

    <div class="flex justify-center mb-6">
      <div class="bg-gradient-to-r from-izzy-pink-500 to-izzy-purple-500 rounded-full w-16 h-16 flex items-center justify-center">
        <span class="text-white text-2xl font-bold">IZZY</span>
      </div>
    </div>

    <h2 class="text-xl sm:text-2xl font-bold text-center mb-4">Upgrade Your Experience</h2> <p class="text-center text-gray-600 mb-6">You've used all your free prompts. Subscribe now to get unlimited conversations with IZZY!</p>

    <div class="space-y-4 mb-6">
      <div class="border border-izzy-purple-200 p-4 rounded-lg hover:bg-purple-50 cursor-pointer transition-colors duration-200">
        <div class="flex justify-between items-center"> <h3 class="font-bold text-lg">Monthly</h3> <span class="font-bold text-lg">$20/mo</span> </div>
        <p class="text-sm text-gray-500 mt-1">Cancel anytime</p>
      </div>

      <div class="border-2 border-izzy-purple-500 p-4 rounded-lg bg-purple-50 cursor-pointer relative"> <span class="absolute -top-3 right-4 inline-block bg-izzy-purple-600 text-white text-xs px-2 py-1 rounded-full font-semibold">BEST VALUE</span> <div class="flex justify-between items-center">
          <h3 class="font-bold text-lg">Annual</h3>
          <span class="font-bold text-lg">$16.67/mo</span> </div>
        <p class="text-sm text-gray-500 mt-1">Save $40 - billed annually ($200)</p>
      </div>
    </div>

    <a href="#subscribe" onclick="closeSubscribeModal()" class="block w-full py-3 rounded-full text-white font-semibold bg-gradient-to-r from-izzy-purple-500 to-izzy-pink-500 hover:from-izzy-purple-600 hover:to-izzy-pink-600 text-center transition-all duration-300">
      View Plans
    </a>

    <button onclick="closeSubscribeModal()" class="block w-full text-gray-500 mt-4 hover:underline">
      Maybe Later
    </button>
  </div>
</div>

<div id="shareModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-50 hidden p-4"> <div class="bg-white p-6 rounded-2xl max-w-sm w-full text-center relative fade-in"> <button onclick="closeShareModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700" aria-label="Close share modal">
        <i class="fas fa-times text-lg"></i>
    </button>

    <h2 class="text-2xl font-bold text-izzy-blue mb-4">Your Personal Link</h2>
    <p class="text-sm text-gray-500 mb-2">Tap link to copy</p>

<input  id="personalLink"
        type="text"
        readonly
        onclick="copyReferralLink()"
        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm mb-4
               text-gray-700 select-all cursor-pointer bg-gray-50"
        title="Click to copy link">

<p class="text-sm text-gray-500 mb-4">Or share via:</p>


    <div class="space-y-3">
      <button onclick="shareVia('whatsapp')"  class="share-button w-full py-2 rounded-lg bg-green-500  text-white font-semibold flex items-center justify-center gap-2">
        <i class="fab fa-whatsapp"></i>WhatsApp
      </button>
      <button onclick="shareVia('email')"    class="share-button w-full py-2 rounded-lg bg-blue-500   text-white font-semibold flex items-center justify-center gap-2">
        <i class="fas fa-envelope"></i>Email
      </button>
      <button onclick="shareVia('facebook')"  class="share-button w-full py-2 rounded-lg bg-blue-700   text-white font-semibold flex items-center justify-center gap-2">
        <i class="fab fa-facebook-f"></i>Facebook
      </button>
      <button onclick="shareVia('twitter')"  class="share-button w-full py-2 rounded-lg bg-sky-500    text-white font-semibold flex items-center justify-center gap-2">
        <i class="fab fa-twitter"></i>X / Twitter
      </button>
      <button onclick="shareVia('reddit')"    class="share-button w-full py-2 rounded-lg bg-orange-600 text-white font-semibold flex items-center justify-center gap-2">
        <i class="fab fa-reddit-alien"></i>Reddit
      </button>
    </div>
  </div>
</div>


<div id="recaptcha-container" style="display: none;"></div>

<button id="mobile-menu-button" class="mobile-nav-button fixed top-4 left-4 z-[101] bg-white rounded-full p-2 shadow-md" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-menu">
  <i class="fas fa-bars text-izzy-blue text-xl"></i>
</button>

<div id="mobile-menu" class="mobile-menu">
  <div class="flex justify-end mb-8">
    <button id="close-mobile-menu" aria-label="Close menu">
      <i class="fas fa-times text-izzy-blue text-2xl"></i> </button>
  </div>
  <nav class="flex flex-col space-y-6 text-center"> <a href="#about" class="text-izzy-blue font-semibold text-lg hover:text-izzy-purple-600 mobile-menu-link">About</a>
    <a href="#practice" class="text-izzy-blue font-semibold text-lg hover:text-izzy-purple-600 mobile-menu-link">Practice</a>
    <a href="#subscribe" class="text-izzy-blue font-semibold text-lg hover:text-izzy-purple-600 mobile-menu-link">Subscribe</a> <a href="#share" class="text-izzy-blue font-semibold text-lg hover:text-izzy-purple-600 mobile-menu-link">Share</a> <hr class="border-gray-200 my-4"> <button id="mobile-logoutButton" class="text-red-500 font-semibold text-lg hover:text-red-700 hidden mobile-menu-link">Logout</button>
  </nav>
</div>

<nav class="fixed top-0 left-0 w-full bg-white shadow-md z-40 px-6 py-4 desktop-nav items-center"> 
  <a href="#" onclick="copyReferralLink()"
  class="text-2xl font-bold text-izzy-blue mr-8">IZZY</a>
  <div class="flex items-center space-x-6">
    <a href="#about" class="text-izzy-blue font-semibold hover:text-izzy-purple-600 transition-colors">About</a>
    <a href="#practice" class="text-izzy-blue font-semibold hover:text-izzy-purple-600 transition-colors">Practice</a>
    <a href="#subscribe" class="text-izzy-blue font-semibold hover:text-izzy-purple-600 transition-colors">Subscribe</a> <a href="#share" class="text-izzy-blue font-semibold hover:text-izzy-purple-600 transition-colors">Share</a> </div>
  <div class="ml-auto flex items-center space-x-4">
    <button id="logoutButton" class="text-red-500 font-semibold hover:text-red-700 hidden transition-colors">Logout</button>
  </div>
</nav>

<main id="mainContent" class="pt-24 sm:pt-32 flex flex-col items-center px-4 sm:px-6 pb-20 transition-filter duration-300">

  <section id="hero" class="text-center max-w-4xl mb-12 fade-in"> <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold bg-gradient-to-r from-izzy-purple-600 to-izzy-pink-600 bg-clip-text text-transparent leading-tight mb-4">
      The World's First <br/> AI-Avatar for Real Life
    </h1>
    <p class="text-lg text-gray-700 mb-8 max-w-2xl mx-auto"> Practice conversations, build confidence, and never be afraid to approach someone again.<br/>Try it for free (after login).
    </p>

    <div class="w-full max-w-xl mx-auto relative mb-10" style="padding-bottom: 75%;"> <iframe id="avatarFrame"
        class="absolute top-0 left-0 w-full h-full rounded-3xl shadow-lg border border-purple-200"
        allow="microphone; autoplay"
        loading="lazy"
        title="IZZY AI Avatar" src="https://studio.d-id.com/share?id=74b55d9015a0b211877183414aae362e&utm_source=copy">
      </iframe>
    </div>
  </section>

  <section id="practice" class="glass max-w-xl w-full text-center fade-in mb-6" style="animation-delay:.2s">
    <label for="userInput" class="block text-lg font-semibold mb-3">Say something to IZZY:</label>
    <div class="relative">
        <label for="userInput" class="sr-only">Your message to IZZY</label> <!-- Add this -->
        <textarea id="userInput" rows="3" maxlength="400" placeholder="Type or speak your message here… (max 400 chars)"
              aria-label="Your message to IZZY"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-2 resize-none focus:ring-2 focus:ring-izzy-purple-500 focus:border-transparent pr-10" ></textarea>
        <button id="micButton" onclick="startDictation()" class="absolute right-3 top-3 text-gray-500 hover:text-巴巴-purple-600" aria-label="Use voice input">
            <i class="fas fa-microphone text-xl"></i>
        </button>

  <!-- ▲  NEW BLOCK ENDS HERE ▲ -->

  <div class="flex flex-col sm:flex-row justify-center items-center gap-3">
    <!-- send / restart buttons -->
  </div>

    <div class="flex flex-col sm:flex-row justify-center items-center gap-3">
        <button id="sendButton"
                class="w-full sm:w-auto bg-gradient-to-r from-izzy-purple-600 to-izzy-pink-500 text-white px-8 py-3 rounded-full shadow hover:from-izzy-purple-700 hover:to-izzy-pink-600 transition-all duration-300 flex items-center justify-center">
          <span class="send-btn-text">Send Message</span>
          <span class="spinner hidden ml-2"></span>
        </button>
        <button id="restartBtn"
                class="w-full sm:w-auto hidden bg-gray-200 text-gray-800 px-6 py-3 rounded-full hover:bg-gray-300 transition-colors">
          Restart Conversation
        </button>
    </div>

    <!-- …existing textarea + buttons … -->

<div id="prompts-warning"
class="text-sm text-orange-600 mt-3 hidden">
<strong>Note:</strong> You have
<span id="prompts-warning-count">0</span> free prompts left.
<a href="#subscribe"
class="underline text-izzy-purple-600">Subscribe</a> for unlimited.
</div>

</section>

  <section id="conversation-history" class="glass max-w-xl w-full mt-6 hidden fade-in" style="animation-delay:.3s">
    <h3 class="font-semibold text-lg mb-3 text-center">Conversation History</h3>
    <div id="chat-container" class="max-h-64 overflow-y-auto space-y-3 p-1"> </div>
  </section>


  <div id="stats" class="mt-10 w-full max-w-xl fade-in" style="animation-delay:.4s"> <h3 class="text-xl font-semibold mb-4 text-center">Your Progress</h3>
    <div class="grid grid-cols-3 gap-4 text-center bg-gray-50 p-4 rounded-lg">
      <div>
        <div id="conversation-count" class="text-2xl font-bold text-izzy-purple-600">0</div>
        <div class="text-sm text-gray-500">Conversations</div>
      </div>
      <div>
        <div id="skill-level" class="text-2xl font-bold text-izzy-purple-600">Beginner</div>
        <div class="text-sm text-gray-500">Level</div>
      </div>
      <div>
        <div id="prompts-left" class="text-2xl font-bold text-izzy-purple-600">3</div>
        <div class="text-sm text-gray-500">Free Prompts</div>
      </div>
    </div>
  </div>

  <section id="about" class="max-w-3xl mt-16 sm:mt-20 px-4 sm:px-8 text-center text-gray-800 fade-in" style="animation-delay:.5s">
    <h2 class="text-3xl font-bold text-izzy-purple-700 mb-3">IZZY Was Built For You!</h2>
    <p class="text-lg italic font-semibold text-izzy-purple-600 mb-5">Stop texting. Stop hiding behind a screen.</p>
    <p class="text-lg leading-relaxed">
      IZZY isn't just another dating app – it's your personal conversation coach. Practice approaching and talking to women in realistic scenarios, guided by AI.
    </p>
    <p class="mt-4 text-lg leading-relaxed">
       Our upcoming full version will let you personalize IZZY to simulate specific situations and personalities. Help us empower more men to build real confidence!
    </p>
     <a href="#share" class="inline-block mt-6 bg-gradient-to-r from-izzy-purple-500 to-izzy-pink-500 text-white px-6 py-3 rounded-full shadow hover:from-izzy-purple-600 hover:to-izzy-pink-600 transition-all duration-300">
        Share IZZY & Earn Rewards
    </a>
  </section>

  <section id="subscribe" class="w-full mt-16 sm:mt-20 fade-in" style="animation-delay: 0.6s;">
    <div class="text-center mb-12">
      <div class="flex justify-center mb-6">
        <div class="bg-gradient-to-r from-pink-500 to-purple-500 rounded-full w-16 h-16 flex items-center justify-center">
          <span class="text-white text-2xl font-bold">IZZY</span>
        </div>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Choose Your Plan</h1>
      <p class="text-lg text-gray-600 mt-4">Select the subscription that fits your needs</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-5xl mx-auto">
      <div class="plan-card bg-white rounded-3xl shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-6">
          <h2 class="text-2xl font-semibold text-gray-800">One Month</h2>
          <div class="mt-4 flex items-end">
            <span class="text-4xl font-bold text-purple-700">$30</span>
            <span class="text-lg text-gray-600 ml-2">/ one-time</span>
          </div>
        </div>
        <div class="p-6">
          <ul class="space-y-4 mb-8">
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Unlimited prompts</span>
            </li>
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Personalized Avatar</span>
            </li>
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Basic Conversational Training</span>
            </li>
          </ul>
          <a href="https://buy.stripe.com/test_PLACEHOLDER_1" target="_blank" class="block text-center bg-white border-2 border-purple-500 text-purple-600 font-semibold py-3 px-6 rounded-full hover:bg-purple-50 transition duration-300">
            Subscribe
          </a>
        </div>
      </div>

      <div class="plan-card gradient-border bg-white rounded-3xl shadow-xl overflow-hidden relative transform md:scale-105"> <div class="popular-badge">Most Popular</div>
        <div class="bg-gradient-to-r from-purple-600 to-pink-500 p-6 text-white">
          <h2 class="text-2xl font-semibold">Monthly</h2>
          <div class="mt-4 flex items-end">
            <span class="text-4xl font-bold">$20</span>
            <span class="text-lg ml-2">/ month</span>
          </div>
        </div>
        <div class="p-6">
          <ul class="space-y-4 mb-8">
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Unlimited prompts</span>
            </li>
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Personalized Avatar</span>
            </li>
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Advanced Conversational Training</span>
            </li>
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Cancel anytime</span>
            </li>
          </ul>
          <a href="https://buy.stripe.com/test_dR6aHO9PM10AcR60oo" target="_blank" class="block text-center bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold py-3 px-6 rounded-full hover:from-purple-700 hover:to-pink-600 transition duration-300">
            Subscribe Now
          </a>
        </div>
      </div>

      <div class="plan-card bg-white rounded-3xl shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-6">
          <h2 class="text-2xl font-semibold text-gray-800">Annual</h2>
          <div class="mt-4 flex items-end">
            <span class="text-4xl font-bold text-purple-700">$200</span>
            <span class="text-lg text-gray-600 ml-2">/ year</span>
          </div>
          <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded mt-2">Save $40</span>
        </div>
        <div class="p-6">
          <ul class="space-y-4 mb-8">
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Unlimited prompts</span>
            </li>
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Personalized Avatar</span>
            </li>
            <li class="flex items-center">
             <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Premium Conversational Training</span>
            </li>
            <li class="flex items-center">
              <span class="bg-purple-100 rounded-full p-1 mr-3 flex-shrink-0"><i class="fas fa-check text-purple-600 text-xs"></i></span>
              <span>Priority Support</span>
            </li>
          </ul>
           <a href="https://buy.stripe.com/test_6oE3cO9PM2h66qU4gg" target="_blank" class="block text-center bg-white border-2 border-purple-500 text-purple-600 font-semibold py-3 px-6 rounded-full hover:bg-purple-50 transition duration-300">
            Subscribe
          </a>
        </div>
      </div>
    </div>

    <div class="mt-12 text-center max-w-2xl mx-auto">
      <h3 class="text-xl font-semibold text-gray-700 mb-4">Why Subscribe to IZZY?</h3>
      <p class="text-gray-600 mb-6">
        IZZY is not a dating app or a flirting asistant. Izzy helps you develop real confidence by providing a safe space to practice conversing with women. No more anxiety, no more awkward silences - just genuine communication skills you can use in real life.
      </p>
      <div class="flex flex-wrap justify-center gap-4 mt-8">
        <div class="bg-gray-50 px-4 py-2 rounded-full text-gray-600 flex items-center text-sm">
          <i class="fas fa-shield-alt w-5 h-5 mr-2 text-purple-500"></i> 100% Safe Practice
        </div>
        <div class="bg-gray-50 px-4 py-2 rounded-full text-gray-600 flex items-center text-sm">
          <i class="fas fa-comments w-5 h-5 mr-2 text-purple-500"></i> Realistic Interactions
        </div>
        <div class="bg-gray-50 px-4 py-2 rounded-full text-gray-600 flex items-center text-sm">
          <i class="fas fa-clock w-5 h-5 mr-2 text-purple-500"></i> 24/7 Availability
        </div>
      </div>
    </div>
  </section>

  <section id="share" class="w-full mt-16 sm:mt-20 fade-in" style="animation-delay: 0.7s;">
    <header class="text-center">
      <div class="flex justify-center mb-6">
        <div class="bg-gradient-to-r from-pink-500 to-purple-500 rounded-full w-16 h-16 flex items-center justify-center">
          <span class="text-white text-2xl font-bold">IZZY</span>
        </div>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Share IZZY</h1>
      <p class="text-lg text-gray-600 mt-4">Help friends discover real confidence with women</p>
      <p id="rewardsText" class="text-md text-purple-700 mt-2 font-semibold">Log in to start sharing & earn free prompts!</p>
    </header>

    <div class="max-w-4xl w-full gradient-bg rounded-3xl p-8 mx-auto mt-12">
      <div class="flex flex-col md:flex-row items-center">
        <div class="w-full md:w-1/2 mb-8 md:mb-0 md:pr-8">
          <img src="https://placehold.co/600x400/E9D5FF/6D28D9?text=IZZY+In+Action" alt="IZZY demo showing conversation practice" class="rounded-2xl shadow-lg w-full">
        </div>
        <div class="w-full md:w-1/2">
          <h2 class="text-2xl font-bold text-purple-700 mb-4">Why Share IZZY?</h2>
          <p class="text-gray-700 mb-6">
            IZZY lets you practice genuine conversations without fear. If you know a friend who could use it, and it may be valuable to him, share your link and both of you benefit free prompts!
          </p>
          <div class="gradient-card p-4">
            <p class="text-gray-800 font-medium">
                "I always got stressed out before talking to a woman and never even thought about approaching them. But IZZY helped me practice, preparing me for any awkward silences or moments, and now I'm much more confident! Thank you!"
            </p>
            <p class="text-right text-sm text-gray-500 mt-2">– Michael T.</p>
        </div>
        </div>
      </div>
    </div>

    <div class="max-w-4xl w-full mx-auto mt-16">
      <h2 class="text-2xl font-bold text-center text-purple-700 mb-8">Your Referral Progress</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
          <h3 class="text-lg font-semibold mb-2">Refer 1 friend</h3>
          <p class="text-2xl font-bold text-izzy-purple-600 mb-4">+5 free prompts</p>
          <button id="btnTier1" onclick="openShareModal()"
            class="share-button bg-gradient-to-r from-purple-600 to-pink-500 text-white font-medium py-2 px-6 rounded-full w-full">
            Share Now
          </button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
          <h3 class="text-lg font-semibold mb-2">Refer 2 friends</h3>
          <p class="text-2xl font-bold text-izzy-purple-600 mb-4">+10 free prompts</p>
          <button id="btnTier2" onclick="openShareModal()"
            class="share-button bg-gradient-to-r from-purple-600 to-pink-500 text-white font-medium py-2 px-6 rounded-full w-full">
            Share More
          </button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
          <h3 class="text-lg font-semibold mb-2">Refer 3 friends</h3>
          <p class="text-2xl font-bold text-izzy-purple-600 mb-4">+20 free prompts</p>
          <button id="btnTier3" onclick="openShareModal()"
            class="share-button bg-gradient-to-r from-purple-600 to-pink-500 text-white font-medium py-2 px-6 rounded-full w-full">
            Unlock Max Rewards
          </button>
        </div>
      </div>
       <p id="referralStatus" class="text-center text-gray-600 mt-6"></p> </div>
  </section>

  <section id="terms" class="max-w-3xl mt-16 sm:mt-20 px-4 sm:px-8 text-gray-800 fade-in">
    <h2 class="text-3xl font-bold text-izzy-purple-700 mb-3">Terms of Service</h2>
    <p class="text-lg leading-relaxed">
        Welcome to IZZY! By using our service, you agree to the following terms...
        <!-- Add your full Terms of Service here -->
    </p>
</section>
<section id="privacy" class="max-w-3xl mt-16 sm:mt-20 px-4 sm:px-8 text-gray-800 fade-in">
    <h2 class="text-3xl font-bold text-izzy-purple-700 mb-3">Privacy Policy</h2>
    <p class="text-lg leading-relaxed">
        At IZZY, we value your privacy. This Privacy Policy explains how we collect, use, and protect your data...
        <!-- Add your full Privacy Policy here -->
    </p>
</section>

</main>

<footer class="bg-gradient-to-r from-purple-600 to-pink-500 text-white py-6 px-6 mt-20 fade-in" style="animation-delay: 0.8s;">
  <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center">
    <div class="text-center md:text-left mb-4 md:mb-0">
      <div class="text-2xl font-bold mb-1">IZZY</div>
      <p class="text-sm opacity-80">AI Avatar for Real Conversations</p>
    </div>
    <div class="flex space-x-4">
      <a href="#terms" class="hover:text-white opacity-80 hover:opacity-100">Terms</a> <a href="#privacy" class="hover:text-white opacity-80 hover:opacity-100">Privacy</a> <a href="mailto:support@example.com" class="hover:text-white opacity-80 hover:opacity-100">Support</a> </div>
  </div>
</footer>


<div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-[120]"> </div>

<script>
// Constants
const FREE_PROMPT_LIMIT = 3;
const MAX_REFERRALS_REWARDED = 3;
const REFERRAL_PROMPTS_TIERS = { 1: 5, 2: 10, 3: 20 };
const ACTION_CODE_SETTINGS = {
  url: window.location.href,
  handleCodeInApp: true
};

// Local Storage Keys
const LS_KEY_PROMPTS = 'izzy_prompts_left_backup';
const LS_KEY_CHAT = 'izzy_chat_history_backup';
const LS_KEY_REFERRER = 'storedInviterUid';
const LS_KEY_REFERRAL_VISITED_PREFIX = 'visitedAsReferral_';

// Global state variables
let currentUser = null;
let currentUserId = null;
let promptsUsed = 0;
let promptsLeft = FREE_PROMPT_LIMIT;
let isSubscribed = false;
let currentConversationId = null;
let personalReferralLink = "";
let successfulReferralCount = 0;
let auth;
let db;

// Initialize firebase and set up auth listener
function initializeFirebase() {
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase Initialized");
    } else {
      firebase.app();
      console.log("Firebase Already Initialized");
    }
    
    auth = firebase.auth();
    db = firebase.database();
    
    // Set up auth state listener
    auth.onAuthStateChanged(handleAuthStateChange);
    
    return true;
  } catch (e) {
    console.error("Firebase initialization failed:", e);
    showToast("Failed to initialize application. Please refresh the page.", true);
    return false;
  }
}

// Handle auth state changes
function handleAuthStateChange(user) {
  if (user) {
    const isNewUser = user.metadata.creationTime === user.metadata.lastSignInTime;
    currentUser = user;
    currentUserId = user.uid;
    console.log("User signed in:", currentUserId, "Is new user:", isNewUser);
    personalReferralLink = `${window.location.origin}${window.location.pathname}?ref=${currentUserId}`;
    if (domElements.personalLinkInput) domElements.personalLinkInput.value = personalReferralLink;
    updateAuthUI(true);
    domElements.authModal?.classList.add('hidden');
    domElements.mainContent?.classList.remove('blur-background');
    loadUserData(currentUserId);
    if (isNewUser) {
      creditReferrerOnSignUp(currentUserId);
    }
  } else {
    console.log("User signed out.");
    currentUser = null;
    currentUserId = null;
    personalReferralLink = "";
    successfulReferralCount = 0;
    updateAuthUI(false);
    resetAppState();
    updateShareSectionUI();
    openAuthModal();
  }
}

// Authentication Functions
function sendMagicLink(event) {
  if (event) event.preventDefault();
  
  // Make sure Firebase is initialized
  if (!auth) {
    console.error("Auth not initialized");
    showStatusMessage("Authentication system is not ready. Please refresh the page.", true);
    return;
  }
  
  // Hide the verification form if it's visible
  if (domElements.verificationFormContainer) {
    domElements.verificationFormContainer.classList.add('hidden');
  }
  
  // Show the email form
  if (domElements.emailForm) {
    domElements.emailForm.classList.remove('hidden');
  }
  
  const email = domElements.emailInput.value.trim();
  if (!email) {
    showStatusMessage("Please enter your email address.", true);
    return;
  }
  
  // Validate email
  if (!validateEmail(email)) {
    showStatusMessage("Please enter a valid email address.", true);
    return;
  }
  
  showButtonLoading(domElements.emailSubmitBtn, domElements.emailButtonText, domElements.emailButtonSpinner, true);
  showStatusMessage(`Sending magic link to ${email}...`, false);
  
  // Make sure we're using the current URL in the action code settings
  const currentActionCodeSettings = {
    url: window.location.href,
    handleCodeInApp: true
  };
  
  auth.sendSignInLinkToEmail(email, currentActionCodeSettings)
    .then(() => {
      // Save the email locally so you don't need to ask the user for it again
      window.localStorage.setItem('emailForSignIn', email);
      
      // Show success message
      showStatusMessage(`Magic link sent to ${email}! Please check your inbox and spam folder.`, false);
      showToast("Email sent successfully! Check your inbox.", false);
      
      // Clear the input field
      domElements.emailInput.value = '';
    })
    .catch((error) => {
      console.error("Error sending magic link:", error);
      let message = "Failed to send magic link. Please try again.";
      
      // Handle specific errors
      if (error.code === 'auth/invalid-email') {
        message = "Invalid email address.";
      } else if (error.code === 'auth/unauthorized-domain') {
        message = "This domain is not authorized. Contact support.";
      } else if (error.code === 'auth/operation-not-allowed') {
        message = "Email/password accounts are not enabled. Contact support.";
      }
      
      showStatusMessage(message, true);
      showToast("Error: " + message, true);
    })
    .finally(() => {
      showButtonLoading(domElements.emailSubmitBtn, domElements.emailButtonText, domElements.emailButtonSpinner, false);
    });
}

// Event Listeners
function addEventListeners() {
  domElements.emailForm?.addEventListener('submit', sendMagicLink);
  domElements.logoutButton?.addEventListener('click', logout);
  domElements.mobileLogoutButton?.addEventListener('click', () => {
    logout();
    closeMobileMenu();
  });
  domElements.sendButton?.addEventListener('click', sendMessage);
  domElements.restartBtn?.addEventListener('click', restartConversation);
  domElements.userInput?.addEventListener('keydown', (event) => {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  });
  domElements.micButtonIcon?.parentElement?.addEventListener('click', startDictation);
  domElements.mobileMenuButton?.addEventListener('click', toggleMobileMenu);
  domElements.closeMobileMenuButton?.addEventListener('click', closeMobileMenu);
  domElements.mobileMenuLinks?.forEach(link => {
    link?.addEventListener('click', (e) => {
      if (link.getAttribute('href')?.startsWith('#') || link.tagName === 'BUTTON') {
        closeMobileMenu();
      }
    });
  });
  domElements.subscribeModal?.addEventListener('click', (e) => {
    if (e.target === domElements.subscribeModal) closeSubscribeModal();
  });
  domElements.shareModal?.addEventListener('click', (e) => {
    if (e.target === domElements.shareModal) closeShareModal();
  });
  domElements.personalLinkInput?.addEventListener('click', copyReferralLink);
  Object.values(domElements.shareTierButtons || {}).forEach(button => {
    button?.addEventListener('click', openShareModal);
  });
  document.getElementById('promptCoffee')?.addEventListener('click', () => usePrompt('Hi, I noticed you at the coffee shop'));
  document.getElementById('promptIntro')?.addEventListener('click', () => usePrompt('Excuse me, I just wanted to introduce myself'));
  document.getElementById('promptCompliment')?.addEventListener('click', () => usePrompt('I like your style, where did you get that?'));
  const mainSubButtons = document.querySelectorAll('#subscribe .plan-card a[target="_blank"]');
  mainSubButtons.forEach(button => {
    button?.addEventListener('click', (e) => {
      if (!currentUser) {
        e.preventDefault();
        showToast("Please log in before subscribing.", true);
      } else {
        console.log("Proceeding to subscription:", button.href);
      }
    });
  });
}

// Initialization
document.addEventListener('DOMContentLoaded', () => {
  // Cache DOM elements first
  cacheDomElements();
  
  // Show loading state on button
  if (domElements.emailSubmitBtn) {
    domElements.emailSubmitBtn.disabled = true;
    if (domElements.emailButtonText) {
      domElements.emailButtonText.textContent = "Loading...";
    }
  }
  
  // Initialize Firebase
  const firebaseInitialized = initializeFirebase();
  
  if (firebaseInitialized) {
    // Check for magic link sign-in
    handleMagicLinkSignIn();
    
    // Add event listeners
    addEventListeners();
    
    // Check for referral link
    handleReferralVisit();
    
    // Enable the submit button
    if (domElements.emailSubmitBtn) {
      domElements.emailSubmitBtn.disabled = false;
      if (domElements.emailButtonText) {
        domElements.emailButtonText.textContent = "Send Magic Link";
      }
    }
  } else {
    // Firebase failed to initialize - show error message
    showStatusMessage("Failed to initialize application. Please check your internet connection and try again.", true);
    if (domElements.emailSubmitBtn) {
      domElements.emailSubmitBtn.disabled = true;
    }
  }
});

// Microphone Permission
function requestMicPermission() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      stream.getTracks().forEach(t => t.stop());
      console.log("Microphone permission granted");
    })
    .catch(err => {
      console.warn("Mic permission denied:", err);
    });
}
document.addEventListener('DOMContentLoaded', requestMicPermission);

function handleMagicLinkSignIn() {
  // Make sure auth is initialized
  if (!auth) {
    console.error("Auth not initialized");
    return;
  }

  // Check if the URL contains the sign-in link
  if (auth.isSignInWithEmailLink(window.location.href)) {
    console.log("Magic link detected in URL");
    
    // Get the email from localStorage
    let email = window.localStorage.getItem('emailForSignIn');
    
    if (!email) {
      // If no email is found, show the verification form
      console.log("No email found in localStorage, showing verification form");
      
      if (domElements.emailForm) {
        domElements.emailForm.classList.add('hidden');
      }
      
      if (domElements.verificationFormContainer) {
        domElements.verificationFormContainer.classList.remove('hidden');
        
        // Add a one-time click event listener to the verification button
        if (domElements.verifyLinkBtn) {
          const verifyButton = domElements.verifyLinkBtn;
          verifyButton.addEventListener('click', function onVerifyClick() {
            completeSignInWithVerification();
            // Remove the event listener after it's used
            verifyButton.removeEventListener('click', onVerifyClick);
          });
        }
      }
      
      return;
    }
    
    completeSignIn(email);
  }
}

function completeSignInWithVerification() {
  const email = domElements.verificationEmail?.value.trim();
  
  if (!email || !validateEmail(email)) {
    showStatusMessage("Please enter a valid email address.", true);
    return;
  }
  
  showButtonLoading(domElements.verifyLinkBtn, domElements.verifyLinkText, domElements.verifyLinkSpinner, true);
  completeSignIn(email);
}

function completeSignIn(email) {
  showStatusMessage("Signing you in...", false);
  
  auth.signInWithEmailLink(email, window.location.href)
    .then((result) => {
      console.log("Signed in with email link successfully");
      
      // Clear the email from storage
      window.localStorage.removeItem('emailForSignIn');
      
      // Remove the sign-in query parameters from the URL
      if (window.history && window.history.replaceState) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Hide auth modal
      domElements.authModal?.classList.add('hidden');
      domElements.mainContent?.classList.remove('blur-background');
      
      // Show success message
      showToast("Welcome! You're now signed in.");
      
      const isNewUser = result.additionalUserInfo?.isNewUser;
      if (isNewUser) {
        creditReferrerOnSignUp(result.user.uid);
      }
    })
    .catch((error) => {
      console.error("Error signing in with email link:", error);
      let message = "Error signing in. Please try again.";
      
      if (error.code === 'auth/expired-action-code') {
        message = "The sign-in link has expired. Please request a new one.";
      } else if (error.code === 'auth/invalid-action-code') {
        message = "Invalid sign-in link. Please request a new one.";
      } else if (error.code === 'auth/invalid-email') {
        message = "Invalid email. Please check and try again.";
      } else if (error.code === 'auth/user-disabled') {
        message = "This account has been disabled. Please contact support.";
      }
      
      showStatusMessage(message, true);
      window.localStorage.removeItem('emailForSignIn');
      
      // Show the email form again
      if (domElements.verificationFormContainer) {
        domElements.verificationFormContainer.classList.add('hidden');
      }
      
      if (domElements.emailForm) {
        domElements.emailForm.classList.remove('hidden');
      }
    })
    .finally(() => {
      if (domElements.verifyLinkBtn && domElements.verifyLinkText && domElements.verifyLinkSpinner) {
        showButtonLoading(domElements.verifyLinkBtn, domElements.verifyLinkText, domElements.verifyLinkSpinner, false);
      }
    });
}

function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(String(email).toLowerCase());
}

function sendMessage() {
  const messageText = domElements.userInput.value.trim();
  if (!messageText) return;
  
  if (!currentUser || !currentUserId) {
    showToast("Please sign in to chat with IZZY", true);
    return;
  }
  
  if (!isSubscribed && promptsLeft <= 0) {
    openSubscribeModal();
    showToast("Please subscribe to continue chatting.", true);
    disableSendButton();
    return;
  }
  
  showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, true);
  
  // Add the user's message to the chat history
  addMessageToHistory(messageText, 'user');
  
  // Create a new conversation if needed
  if (!currentConversationId) {
    currentConversationId = db.ref(`chats/${currentUserId}`).push().key;
    updateUserData(currentUserId, { 
      currentConversationId: currentConversationId, 
      conversations: firebase.database.ServerValue.increment(1) 
    })
    .catch(err => console.error("Failed to update conversation ID/count:", err));
  }
  
  // Save the user's message
  saveMessage(currentUserId, currentConversationId, messageText, 'user')
    .catch(error => {
      console.error("Failed to save user message:", error);
      showToast("Error sending message. Please try again.", true);
    });
  
  // Simulate AI response
  const simulateApiCall = new Promise((resolve) => {
    setTimeout(() => {
      const responses = [
        "That's interesting! Tell me more.",
        "Okay, I see. What happened next?",
        "How did that make you feel?",
        "Hmm, let's think about that.",
        "Got it. What's on your mind now?",
        "Can you elaborate on that point?",
        "What are your thoughts on trying this approach...?"
      ];
      resolve(responses[Math.floor(Math.random() * responses.length)]);
    }, 1500);
  });
  
  simulateApiCall
    .then(aiResponse => {
      // Add AI response to the chat history
      addMessageToHistory(aiResponse, 'assistant');
      
      // Save the AI response
      return saveMessage(currentUserId, currentConversationId, aiResponse, 'assistant');
    })
    .then(() => {
      // Update prompt count if not subscribed
      if (!isSubscribed) {
        // Decrement prompts left (both locally and in DB)
        promptsLeft = Math.max(0, promptsLeft - 1);
        promptsUsed += 1;
        
        console.log("Updating prompts - Left:", promptsLeft, "Used:", promptsUsed);
        
        // Update the UI immediately
        updatePromptsUI();
        checkSubscriptionStatus();
        
        // Then update in the database
        return db.ref(`users/${currentUserId}`).update({
          promptsLeft: promptsLeft,
          promptsUsed: promptsUsed
        });
      }
      return Promise.resolve();
    })
    .catch(error => {
      console.error("Error in message handling:", error);
      showToast("Error getting response. Please try again.", true);
    })
    .finally(() => {
      // Reset the input field and button state
      showButtonLoading(domElements.sendButton, domElements.sendButtonText, domElements.sendButtonSpinner, false);
      domElements.userInput.value = '';
      domElements.userInput.focus();
    });
}
</script>
</body>
</html>