<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IZZY â€“ AI Avatar for Real Conversations</title>

  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body  { font-family: 'Inter', sans-serif; background: #fff; color:#333; }

    /* Backdropâ€‘blur card */
    .glass {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 20px 25px rgba(0,0,0,0.05);
    }

    /* Modal backdrop blur */
    .blur-background { filter: blur(8px); pointer-events:none; }

    /* Simple fadeâ€‘in */
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:none;} }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }

    /* Hidden helper */
    .hidden { display:none; }

    /* Chat bubbles */
    .chat-bubble {
      border-radius: 18px;
      padding: 10px 15px;
      max-width: 80%;
      margin-bottom: 10px;
    }
    .user-bubble {
      background-color: #E9F3FF;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .assistant-bubble {
      background-color: #F2F2F7;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
  </style>
</head>

<body class="text-gray-900">

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MODAL (Auth) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full fade-in">
    <!-- Logo -->
    <div class="flex justify-center mb-6">
      <div class="bg-gradient-to-r from-pink-500 to-purple-500 rounded-full w-16 h-16 flex items-center justify-center">
        <span class="text-white text-2xl font-bold">IZZY</span>
      </div>
    </div>
    <!-- Headings -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-semibold text-gray-900">Real Conversations.</h1>
      <h2 class="text-3xl font-semibold text-gray-900 mb-4">Real Confidence.</h2>
    </div>

    <!-- Google Signâ€‘in -->
    <button id="google-signin-btn"
      class="w-full flex items-center justify-center border border-gray-300 rounded-full py-3 mb-4 hover:bg-gray-50">
      <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.1H42V20H24v8h11.3c-1.6 4.7-6.1 8-11.3 8-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.8 1.2 8 3l5.7-5.7C34 6 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.6-.4-3.9z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 15.1 19 12 24 12c3.1 0 5.8 1.2 8 3l5.7-5.7C34 6 29.3 4 24 4c-7.7 0-14.4 4.3-17.7 10.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-2 13.4-5.2l-6.2-5.2C29.2 35.1 26.7 36 24 36c-5.2 0-9.6-3.3-11.3-7.9l-6.5 5C9.5 39.6 16.2 44 24 44z"/><path fill="#1976D2" d="M43.6 20.1H42V20H24v8h11.3c-.8 2.2-2.2 4.2-4.1 5.6l6.2 5.2C37 39.2 44 34 44 24c0-1.3-.1-2.6-.4-3.9z"/></svg>
      <span class="text-gray-700 font-medium">Continue with Google</span>
    </button>

    <!-- Separator -->
    <div class="flex items-center text-gray-500 text-sm my-4">
      <div class="flex-1 border-t border-gray-300"></div>
      <span class="px-3">OR</span>
      <div class="flex-1 border-t border-gray-300"></div>
    </div>

    <!-- Email magicâ€‘link -->
    <form id="email-form">
      <input type="email" id="email" placeholder="Enter your email"
             class="w-full px-4 py-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-purple-500 mb-3"
             required />
      <button type="submit"
        class="w-full py-3 rounded-full text-white font-semibold bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600">
        Send Magic Link
      </button>
    </form>

    <!-- Error -->
    <div id="error-message" class="text-center text-sm text-red-600 mt-3 min-h-[1.2em]"></div>

    <p class="text-center text-xs text-gray-500 mt-4">
      By continuing, you agree to our
      <a href="#" class="text-purple-500 hover:underline">Terms</a> &
      <a href="#" class="text-purple-500 hover:underline">Privacy</a>.
    </p>
  </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SUBSCRIBE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="subscribeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full fade-in">
    <!-- Logo -->
    <div class="flex justify-center mb-6">
      <div class="bg-gradient-to-r from-pink-500 to-purple-500 rounded-full w-16 h-16 flex items-center justify-center">
        <span class="text-white text-2xl font-bold">IZZY</span>
      </div>
    </div>
    
    <!-- Content -->
    <h2 class="text-2xl font-bold text-center mb-4">Upgrade Your Experience</h2>
    <p class="text-center mb-6">You've used all your free prompts. Subscribe now to get unlimited conversations with IZZY!</p>
    
    <!-- Subscription Options -->
    <div class="space-y-4 mb-6">
      <div class="border border-purple-200 p-4 rounded-lg hover:bg-purple-50 cursor-pointer">
        <div class="flex justify-between">
          <h3 class="font-bold">Monthly</h3>
          <span class="font-bold">$9.99/mo</span>
        </div>
        <p class="text-sm text-gray-500">Cancel anytime</p>
      </div>
      
      <div class="border-2 border-purple-500 p-4 rounded-lg bg-purple-50 cursor-pointer">
        <div class="flex justify-between">
          <h3 class="font-bold">Annual</h3>
          <span class="font-bold">$7.99/mo</span>
        </div>
        <p class="text-sm text-gray-500">Save 20% - billed annually</p>
        <span class="inline-block mt-1 bg-purple-600 text-white text-xs px-2 py-1 rounded-full">BEST VALUE</span>
      </div>
    </div>
    
    <!-- CTA Button -->
    <a href="subscribe.html" class="block w-full py-3 rounded-full text-white font-semibold bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-center">
      Subscribe Now
    </a>
    
    <!-- Close button -->
    <button onclick="closeSubscribeModal()" class="block w-full text-gray-500 mt-4 hover:underline">
      Maybe Later
    </button>
  </div>
</div>

<div id="recaptcha-container"></div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NAVBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav class="fixed top-0 left-0 w-full bg-white shadow-md z-50 px-6 py-4 flex items-center space-x-8">
  <a href="#about" class="text-[#0047AB] font-semibold hover:underline">About</a>
  <a href="#practice" class="text-[#0047AB] font-semibold hover:underline">Practice</a>
  <a href="subscribe.html" class="text-[#0047AB] font-semibold hover:underline">Subscribe</a>
  <a href="share.html" class="text-[#0047AB] font-semibold hover:underline">Share</a>
  <button id="authButton" onclick="openAuthModal()" class="ml-auto text-[#0047AB] font-semibold hover:underline">Login</button>
  <button id="logoutButton" onclick="logout()" class="ml-auto text-red-500 font-semibold hover:underline hidden">Logout</button>
</nav>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main id="mainContent" class="pt-32 flex flex-col items-center px-6 pb-20">

  <!-- Hero -->
  <section class="text-center max-w-4xl mb-12 fade-in">
    <h1 class="text-5xl md:text-6xl font-extrabold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent leading-tight mb-4">
      The World's First <br/> AIâ€‘Avatar for Real Life
    </h1>
    <p class="text-lg text-gray-700 mb-8">Never be afraid to approach a woman again.<br/>Try it for free.</p>

    <iframe id="avatarFrame"
      class="w-full max-w-xl h-[420px] rounded-3xl shadow-lg border border-purple-200 mb-10"
      allow="microphone; autoplay"
      src="https://studio.d-id.com/share?id=74b55d9015a0b211877183414aae362e&utm_source=copy">
    </iframe>
  </section>

  <!-- Practice box -->
  <section id="practice" class="glass max-w-xl w-full text-center fade-in" style="animation-delay:.2s">
    <label for="userInput" class="block text-lg font-semibold mb-2">Say something to IZZY:</label>
    <input id="userInput" type="text" maxlength="400"
           placeholder="Type your question hereâ€¦ (max 50 words)"
           class="w-full px-4 py-3 border rounded-lg mb-2" />
    <button onclick="startDictation()" class="text-sm text-purple-600 hover:underline mb-3">ðŸŽ¤ Speak to IZZY</button><br/>
    <button id="sendButton" onclick="handlePrompt()"
            class="bg-gradient-to-r from-purple-600 to-pink-500 text-white px-6 py-3 rounded-full shadow hover:from-purple-700 hover:to-pink-600">
      Send
    </button>
    <button id="restartBtn" onclick="restartConversation()"
            class="hidden mt-3 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">
      Restart Conversation
    </button>
    
    <div id="prompts-warning" class="text-sm text-orange-600 mt-2 hidden">
      <strong>Note:</strong> You have <span id="prompts-warning-count">0</span> prompts left in your free trial.
    </div>
  </section>

  <!-- Conversation history -->
  <section id="conversation-history" class="glass max-w-xl w-full mt-6">
    <h3 class="font-semibold mb-3">Conversation History</h3>
    <div id="chat-container" class="max-h-64 overflow-y-auto space-y-3">
      <!-- Messages will be added here dynamically -->
    </div>
  </section>

  <!-- Example prompts -->
  <div class="mt-4 flex flex-wrap justify-center gap-2">
    <button onclick="usePrompt('Hi, I noticed you at the coffee shop')" 
            class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200">
      Coffee Shop
    </button>
    <button onclick="usePrompt('Excuse me, I just wanted to introduce myself')" 
            class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200">
      Simple Intro
    </button>
    <button onclick="usePrompt('I like your style, where did you get that?')" 
            class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200">
      Compliment
    </button>
  </div>

  <!-- Stats -->
  <div class="mt-8 w-full max-w-xl">
    <h3 class="text-lg font-semibold mb-2">Your Conversation Skills</h3>
    <div class="grid grid-cols-3 gap-4 text-center">
      <div>
        <div id="conversation-count" class="text-2xl font-bold text-purple-600">0</div>
        <div class="text-sm text-gray-500">Conversations</div>
      </div>
      <div>
        <div id="skill-level" class="text-2xl font-bold text-purple-600">Beginner</div>
        <div class="text-sm text-gray-500">Level</div>
      </div>
      <div>
        <div id="prompts-left" class="text-2xl font-bold text-purple-600">3</div>
        <div class="text-sm text-gray-500">Prompts Left</div>
      </div>
    </div>
  </div>

  <!-- About -->
  <section id="about" class="max-w-4xl mt-20 px-8 text-center text-gray-800 fade-in" style="animation-delay:.4s">
    <h2 class="text-3xl font-bold text-purple-700 mb-2">IZZY Was Built For You!</h2>
    <p class="text-lg italic font-bold text-purple-600 mb-4">No more texting. No more hiding behind a screen.</p>
    <p class="mt-4 text-lg leading-relaxed">
      IZZY isn't a dating app, but a personal coach.<br/>
      Our upcoming full version will let you personalize IZZY to match the
      real woman you want to approach. Stay tuned and help us empower more men
      to gain real confidence!
    </p>
  </section>
</main>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FIREBASE (compat for brevity) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
/* ---------------- Firebase Init ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBlmM-6P2WHj59R5FAvFy6ZjIDA637f7p4",
  authDomain: "izzy-auth.firebaseapp.com",
  projectId: "izzy-auth",
  storageBucket: "izzy-auth.appspot.com",
  messagingSenderId: "573135779043",
  appId: "1:573135779043:web:f6c59473f9956c917041d6"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

// Constants
const FREE_PROMPT_LIMIT = 3;

/* ---------------- Referralâ€‘credit logic ----------------
   URL pattern:  https://your-site.web.app/?ref=<inviterUid>
--------------------------------------------------------*/
const urlParams   = new URLSearchParams(window.location.search);
const inviterUid  = urlParams.get('ref');
const VISITED_KEY = 'visitedAsReferral';     // localStorage flag
const INVITER_KEY = 'storedInviterUid';      // remember for later

if (inviterUid && inviterUid !== 'undefined') {
  // store inviter UID locally
  localStorage.setItem(INVITER_KEY, inviterUid);

  // If first time visiting through this inviter, add +1 to their count
  if (!localStorage.getItem(VISITED_KEY+inviterUid)) {
    const refPath = `referralsReceived/${inviterUid}`;
    db.ref(refPath).transaction(curr => (curr || 0) + 1);
    localStorage.setItem(VISITED_KEY+inviterUid, 'true');
  }
}

/* ---------------- Auth State ---------------- */
const authModal        = document.getElementById('authModal');
const subscribeModal   = document.getElementById('subscribeModal');
const mainContent      = document.getElementById('mainContent');
const errorMessageDiv  = document.getElementById('error-message');
const authButton       = document.getElementById('authButton');
const logoutButton     = document.getElementById('logoutButton');
const recaptchaContainer = document.getElementById('recaptcha-container');
const emailForm        = document.getElementById('email-form');
const chatContainer    = document.getElementById('chat-container');
const conversationHistory = document.getElementById('conversation-history');
const promptsWarning   = document.getElementById('prompts-warning');
const promptsWarningCount = document.getElementById('prompts-warning-count');
let recaptchaVerifier  = null;
let currentUser = null;
let promptsUsed = 0;
let promptsLeft = FREE_PROMPT_LIMIT;
let isSubscribed = false;

auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    authButton.classList.add('hidden');
    logoutButton.classList.remove('hidden');
    authModal.classList.add('hidden');
    mainContent.classList.remove('blur-background');

    // Load user data
    loadUserData(user.uid);

    /* ---------- credit inviter on first signâ€‘up ---------- */
    const storedInviter = localStorage.getItem(INVITER_KEY);
    if (storedInviter && storedInviter !== user.uid) {
      const path = `successfulReferrals/${storedInviter}/${user.uid}`;
      db.ref(path).set(true);  // mark this referral as successful
      localStorage.removeItem(INVITER_KEY); // prevent double credit
    }

  } else {
    currentUser = null;
    authButton.classList.remove('hidden');
    logoutButton.classList.add('hidden');
    openAuthModal();
  }
});

/* ---------------- User Data ---------------- */
function loadUserData(userId) {
  db.ref(`users/${userId}`).once('value').then(snapshot => {
    const userData = snapshot.val() || { 
      conversations: 0, 
      promptsUsed: 0,
      promptsLeft: FREE_PROMPT_LIMIT, 
      level: 'Beginner',
      subscribed: false
    };
    
    // Set global variables
    promptsUsed = userData.promptsUsed || 0;
    promptsLeft = userData.promptsLeft !== undefined ? userData.promptsLeft : FREE_PROMPT_LIMIT;
    isSubscribed = userData.subscribed || false;
    
    // Update UI
    document.getElementById('conversation-count').textContent = userData.conversations || 0;
    document.getElementById('skill-level').textContent = userData.level || 'Beginner';
    document.getElementById('prompts-left').textContent = promptsLeft;
    
    // Show warning if close to limit
    if (promptsLeft <= 1 && !isSubscribed) {
      promptsWarning.classList.remove('hidden');
      promptsWarningCount.textContent = promptsLeft;
    } else {
      promptsWarning.classList.add('hidden');
    }
    
    // Load conversation history if exists
    if (userData.chatHistory && Object.keys(userData.chatHistory).length > 0) {
      // Show conversation history section
      conversationHistory.classList.remove('hidden');
      
      // Clear existing history
      chatContainer.innerHTML = '';
      
      // Add messages to history - sort by timestamp
      const messages = Object.values(userData.chatHistory).sort((a, b) => a.timestamp - b.timestamp);
      messages.forEach(msg => {
        addMessageToHistory(msg.text, msg.sender);
      });
    }
    
    // Check for subscription status
    if (promptsLeft <= 0 && !isSubscribed) {
      disableSendButton();
      openSubscribeModal();
    }
  });
}

function updateUserData(userId, data) {
  return db.ref(`users/${userId}`).update(data);
}

function disableSendButton() {
  const sendButton = document.getElementById('sendButton');
  sendButton.disabled = true;
  sendButton.classList.add('opacity-50');
  sendButton.classList.add('cursor-not-allowed');
}

function enableSendButton() {
  const sendButton = document.getElementById('sendButton');
  sendButton.disabled = false;
  sendButton.classList.remove('opacity-50');
  sendButton.classList.remove('cursor-not-allowed');
}

/* ---------------- Modal helpers ---------------- */
function openAuthModal(){
  authModal.classList.remove('hidden');
  mainContent.classList.add('blur-background');
  clearError();
  setupRecaptcha();
}

function closeAuthModal(){
  authModal.classList.add('hidden');
  mainContent.classList.remove('blur-background');
}

function openSubscribeModal(){
  subscribeModal.classList.remove('hidden');
  mainContent.classList.add('blur-background');
}

function closeSubscribeModal(){
  subscribeModal.classList.add('hidden');
  mainContent.classList.remove('blur-background');
}

function showError(msg){ errorMessageDiv.textContent=msg; }
function clearError()   { errorMessageDiv.textContent=''; }

/* ---------------- reCAPTCHA (invisible) ---------------- */
function setupRecaptcha(){
  if (!recaptchaVerifier){
    recaptchaVerifier = new firebase.auth.RecaptchaVerifier(recaptchaContainer, {
      size: 'invisible',
      callback: () => {
        // reCAPTCHA solved, allow form submission
      }
    });
    recaptchaVerifier.render();
  }
}

/* ---------------- Email magicâ€‘link ---------------- */
emailForm.addEventListener('submit', e => {
  e.preventDefault(); 
  clearError();
  
  const email = document.getElementById('email').value.trim();
  if(!email) {
    showError('Enter your email');
    return;
  }
  
  const actionCodeSettings = {
    url: window.location.href,
    handleCodeInApp: true
  };
  
  auth.sendSignInLinkToEmail(email, actionCodeSettings)
    .then(() => {
      localStorage.setItem('emailForSignIn', email);
      showError('Magic link sent! Check your inbox.');
    })
    .catch(err => showError(err.message));
});

// Check if coming back from email link
if(auth.isSignInWithEmailLink(window.location.href)) {
  let email = localStorage.getItem('emailForSignIn');
  if(!email) {
    email = prompt('Confirm your email to complete sign-in');
  }
  
  if(email) {
    auth.signInWithEmailLink(email, window.location.href)
      .then(() => {
        localStorage.removeItem('emailForSignIn');
        window.history.replaceState(null, null, window.location.pathname);
      })
      .catch(err => showError(err.message));
  }
}

/* ---------------- Google signâ€‘in ---------------- */
document.getElementById('google-signin-btn').onclick = () => {
  clearError();
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
    .catch(err => showError(err.message));
};

/* ---------------- Logout ---------------- */
function logout(){ 
  auth.signOut().then(() => {
    // Clear UI elements
    chatContainer.innerHTML = '';
    conversationHistory.classList.add('hidden');
    document.getElementById('restartBtn').classList.add('hidden');
    promptsWarning.classList.add('hidden');
    
    // Reset variables
    promptsUsed = 0;
    promptsLeft = FREE_PROMPT_LIMIT;
    isSubscribed = false;
    
    // Enable send button
    enableSendButton();
  });
}

/* ---------------- IZZY conversation handlers ---------------- */
function startDictation() {
  if(!('webkitSpeechRecognition' in window)) {
    alert('Speech recognition not supported by your browser');
    return;
  }
  
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-US';
  recognition.continuous = false;
  recognition.interimResults = false;
  
  recognition.start();
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('userInput').value = transcript;
    recognition.stop();
  };
  
  recognition.onerror = () => {
    recognition.stop();
  };
}

// Responses for the demo (would be replaced with actual AI in production)
const botResponses = [
  "Hi there! I'm IZZY. It's nice to meet you!",
  "That's interesting! Tell me more about yourself.",
  "I appreciate you starting a conversation with me. What are you up to today?",
  "I'm actually heading to a yoga class soon. Do you practice yoga?",
  "That's a good question! I got this at a small boutique downtown."
];

<script>
/* ---------------- CONSTANTS ---------------- */
const FREE_PROMPT_LIMIT = 3;
const LS_KEY = 'izzy_prompts_left';   // localStorage backup key

/* ---------------- USERâ€‘DATA LOAD ---------------- */
function loadUserData(uid){
  db.ref(`users/${uid}`).once('value').then(snap=>{
    const data = snap.val() || {};
    promptsUsed   = data.promptsUsed  || 0;
    promptsLeft   = data.promptsLeft ?? FREE_PROMPT_LIMIT;
    isSubscribed  = !!data.subscribed;

    /* fallback if DB empty (first visit) */
    if (!snap.exists()){
      promptsLeft = parseInt(localStorage.getItem(LS_KEY)) || FREE_PROMPT_LIMIT;
    }
    refreshUI();
  });
}

/* ---------------- UI REFRESH ---------------- */
function refreshUI(){
  document.getElementById('prompts-left').textContent = isSubscribed ? 'âˆž' : promptsLeft;
  promptsWarning.classList.toggle('hidden', isSubscribed || promptsLeft>1);
  promptsWarningCount.textContent = promptsLeft;

  const sendBtn = document.getElementById('sendButton');
  if (!isSubscribed && promptsLeft<=0){
    sendBtn.disabled = true;
    sendBtn.classList.add('opacity-50','cursor-not-allowed');
  } else {
    sendBtn.disabled = false;
    sendBtn.classList.remove('opacity-50','cursor-not-allowed');
  }
}

/* ---------------- HANDLE PROMPT ---------------- */
async function handlePrompt(){
  const userInputEl = document.getElementById('userInput');
  const input = userInputEl.value.trim();
  if(!input) return alert('Please type or speak something first');
  if(!currentUser) return openAuthModal();

  /* Guard BEFORE accepting */
  if(!isSubscribed && promptsLeft<=0){
    openSubscribeModal(); return;
  }

  /* Atomic decrement in Firebase */
  if(!isSubscribed){
    const ref = db.ref(`users/${currentUser.uid}/promptsLeft`);
    await ref.transaction(curr=>{
      if (curr===null) curr = FREE_PROMPT_LIMIT;
      return curr>0 ? curr-1 : curr;   // decrement or keep 0
    }).then(res=>{
      promptsLeft = res.snapshot.val();
      localStorage.setItem(LS_KEY, promptsLeft);   // persist across refresh
    });
  }

  /* Now count is updated â€“ proceed */
  addMessageToHistory(input,'user');
  userInputEl.value = '';
  document.getElementById('restartBtn').classList.remove('hidden');
  document.getElementById('conversation-history').classList.remove('hidden');

  refreshUI();

  if(!isSubscribed && promptsLeft<=0){
    setTimeout(()=>openSubscribeModal(), 600);
  }

  /* ---- Simulate IZZY response (keep your existing code) ---- */
  const responseIndex = Math.floor(Math.random()*botResponses.length);
  const botResponse   = botResponses[responseIndex];
  setTimeout(async ()=>{
    addMessageToHistory(botResponse,'assistant');
    const botMsgRef = db.ref(`users/${currentUser.uid}/chatHistory`).push();
    await botMsgRef.set({text:botResponse,sender:'assistant',timestamp:Date.now()});
  }, 1200);
}

/* ---------------- USE PROMPT BUTTONS ---------------- */
function usePrompt(text){
  document.getElementById('userInput').value = text;
}
</script>
